<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mini Messenger</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --border:#24304a; --muted:rgba(230,238,252,.8);
      --btn:#1b2742; --btn2:#12284a;
    }
    *{ box-sizing:border-box; }
    body { font-family: system-ui, Arial; margin: 0; background: var(--bg); color: #e6eefc; }
    .wrap { display: grid; place-items: center; min-height: 100vh; padding: 16px; }
    .card { width: min(1100px, 100%); background: var(--card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .top { display:flex; gap: 10px; padding: 14px; border-bottom: 1px solid var(--border); align-items: center; justify-content: space-between; }
    .top-left{ display:flex; gap:10px; align-items:center; }
    .brand{ font-weight:700; letter-spacing:.2px; }
    .pill{ font-size:12px; opacity:.9; padding: 4px 10px; border:1px solid var(--border); border-radius:999px; background:#0b1220; }
    .top button { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--btn); color:#e6eefc; cursor:pointer; }
    .top button:hover{ filter:brightness(1.08); }

    .grid { display:grid; grid-template-columns: 330px 1fr; height: 76vh; }
    .sidebar { border-right: 1px solid var(--border); padding: 14px; display:flex; flex-direction: column; gap: 12px; min-width: 0; }
    .chat { display:flex; flex-direction: column; }
    .msgs { flex:1; overflow:auto; padding: 14px; display:flex; flex-direction: column; gap: 10px; }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background:#0b1220; }
    .me { align-self: flex-end; background: var(--btn2); }
    .meta { font-size: 12px; opacity: .8; margin-bottom: 4px; }
    .composer { display:flex; gap: 10px; padding: 14px; border-top: 1px solid var(--border); }
    .composer input { flex:1; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background:#0b1220; color:#e6eefc; }
    .composer button { padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border); background: var(--btn); color:#e6eefc; cursor:pointer; }
    .composer button:hover{ filter:brightness(1.08); }

    .row { display:flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .small { font-size: 12px; opacity: .8; word-break: break-word; }
    .sep { height: 1px; background: var(--border); opacity:.8; margin: 6px 0; }

    .chatlist { display:flex; flex-direction: column; gap: 6px; overflow:auto; padding-right: 4px; }
    .chatitem {
      display:flex; align-items: center; justify-content: space-between;
      gap: 8px;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:#0b1220;
      cursor:pointer;
      min-width: 0;
    }
    .chatitem:hover { filter: brightness(1.08); }
    .chatitem.active { background: var(--btn2); }
    .title { font-weight: 650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sub { font-size:11px; opacity:.75; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badge { font-size: 11px; opacity:.9; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; }

    /* Icon buttons */
    .iconbar{ display:flex; gap:8px; }
    .iconbtn{
      width:36px; height:36px; border-radius:10px;
      display:grid; place-items:center;
      border:1px solid var(--border);
      background:#0b1220; color:#e6eefc;
      cursor:pointer; user-select:none;
    }
    .iconbtn:hover{ filter:brightness(1.12); }
    .iconbtn:active{ transform: translateY(1px); }

    /* Popover */
    .pop-wrap{ position: relative; }
    .popover{
      position:absolute; top:44px; left:0;
      width: 300px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display:none;
      z-index: 20;
    }
    .popover.open{ display:block; }
    .popover .head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .popover .head b{ font-size: 13px; }
    .popover input{
      width:100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
    }
    .popover .actions{ display:flex; gap:8px; margin-top:10px; }
    .popover button{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      flex:1;
    }
    .popover button:hover{ filter:brightness(1.08); }
    .xbtn{ width:28px; height:28px; border-radius:10px; border:1px solid var(--border); background:#0b1220; cursor:pointer; }

    /* Modal overlay */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 999;
      padding: 18px;
    }
    .modal-overlay.open{ display:grid; place-items:center; }
    .modal{
      width: min(520px, 100%);
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 18px 50px rgba(0,0,0,.5);
    }
    .modal-top{
      padding: 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .modal-top .tabs{ display:flex; gap:8px; }
    .tab{
      padding: 8px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#0b1220;
      cursor:pointer;
      font-size: 13px;
      opacity:.9;
    }
    .tab.active{ background: var(--btn2); }
    .modal-body{ padding: 14px; display:flex; flex-direction: column; gap: 10px; }
    .modal-body input{
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
    }
    .modal-body .btnrow{ display:flex; gap:10px; margin-top: 6px; }
    .modal-body button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      flex:1;
    }
    .modal-body button:hover{ filter:brightness(1.08); }
    .modal-hint{ font-size: 12px; opacity:.85; }
    .err{ font-size: 12px; color:#ffd3d3; opacity:.95; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="top-left">
          <div class="brand">Mini Messenger</div>
          <div class="pill" id="whoami">not logged in</div>
          <div class="small" id="status"></div>
        </div>
        <div class="row">
          <button id="btnOpenAuth" type="button">Login / Register</button>
          <button id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>

      <div class="grid">
        <!-- Sidebar -->
        <div class="sidebar">
          <div class="row" style="justify-content: space-between;">
            <div class="row" style="gap:10px;">
              <div><b>Chats</b></div>
            </div>

            <div class="iconbar">
              <div class="pop-wrap">
                <div class="iconbtn" id="btnOpenCreateGroup" title="New group chat">‚ûï</div>
                <div class="popover" id="popGroup">
                  <div class="head">
                    <b>–ù–æ–≤—ã–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</b>
                    <button class="xbtn" id="btnCloseGroup" type="button">‚úï</button>
                  </div>
                  <input id="groupTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: work)" />
                  <div class="actions">
                    <button id="btnCreateGroup" type="button">Create</button>
                  </div>
                  <div class="modal-hint" style="margin-top:8px;">–°–æ–∑–¥–∞—Å—Ç —á–∞—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç —Ç–µ–±—è –≤ –Ω–µ–≥–æ.</div>
                </div>
              </div>

              <div class="pop-wrap">
                <div class="iconbtn" id="btnOpenCreateDM" title="New DM">üí¨</div>
                <div class="popover" id="popDM">
                  <div class="head">
                    <b>–ù–æ–≤—ã–π DM</b>
                    <button class="xbtn" id="btnCloseDM" type="button">‚úï</button>
                  </div>
                  <input id="dmUser" placeholder="Username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
                  <div class="actions">
                    <button id="btnCreateDM" type="button">Open DM</button>
                  </div>
                  <div class="modal-hint" style="margin-top:8px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.</div>
                </div>
              </div>

              <div class="iconbtn" id="btnRefreshChats" title="Refresh chats">‚ü≥</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button id="btnLoadHistory" type="button">Load history</button>
          </div>

          <div class="sep"></div>

          <div class="chatlist" id="chatlist"></div>

          <div class="small" style="margin-top:auto;">
            –°–æ–≤–µ—Ç—ã: ‚ûï —Å–æ–∑–¥–∞—ë—Ç –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç, üí¨ —Å–æ–∑–¥–∞—ë—Ç DM, ‚ü≥ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤.
          </div>
        </div>

        <!-- Chat -->
        <div class="chat">
          <div class="msgs" id="msgs"></div>
          <div class="composer">
            <input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button id="btnSend" type="button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal-overlay" id="authOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <div class="tabs">
          <div class="tab active" id="tabLogin">Login</div>
          <div class="tab" id="tabRegister">Register</div>
        </div>
        <button class="xbtn" id="btnCloseAuth" type="button">‚úï</button>
      </div>
      <div class="modal-body">
        <input id="authUsername" placeholder="username (3-20: a-z 0-9 _)" autocomplete="username" />
        <input id="authPassword" placeholder="password (–º–∏–Ω 6)" type="password" autocomplete="current-password" />
        <div class="err" id="authError" style="display:none;"></div>
        <div class="btnrow">
          <button id="btnAuthSubmit" type="button">Login</button>
        </div>
        <div class="modal-hint">
          –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let ws = null;

  let chats = [];
  let activeChatId = localStorage.getItem("activeChatId") || "general";
  let activeChatTitle = "general";

  // ---- helpers ----
  function setStatus(s){ $("status").textContent = s; }
  function setWhoami(){
    $("whoami").textContent = me ? `üë§ ${me}` : "not logged in";
    $("btnLogout").style.display = me ? "" : "none";
    $("btnOpenAuth").style.display = me ? "none" : "";
  }

  function addSystem(text) {
    const div = document.createElement("div");
    div.className = "msg";
    div.style.opacity = ".85";
    div.textContent = text;
    $("msgs").appendChild(div);
    $("msgs").scrollTop = $("msgs").scrollHeight;
  }

  function addMsg({sender, text, created_at}) {
    const div = document.createElement("div");
    div.className = "msg" + (sender === me ? " me" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    const t = new Date(created_at * 1000).toLocaleTimeString();
    meta.textContent = `${sender} ‚Ä¢ ${t}`;
    const body = document.createElement("div");
    body.textContent = text;
    div.appendChild(meta);
    div.appendChild(body);
    $("msgs").appendChild(div);
    $("msgs").scrollTop = $("msgs").scrollHeight;
  }

  async function api(path, method="GET", body=null) {
    const opts = { method, headers: {} };
    if (body) {
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(path, opts);
    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { data = { detail: raw }; }
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${data.detail || raw}`);
    return data;
  }

  // ---- modal auth ----
  let authMode = "login"; // login | register

  function openAuth(mode="login"){
    authMode = mode;
    $("authOverlay").classList.add("open");
    $("authOverlay").setAttribute("aria-hidden", "false");
    $("authError").style.display = "none";
    $("authError").textContent = "";

    setAuthTab(mode);

    // prefill from top remembered
    $("authUsername").value = me || $("authUsername").value || "";
    $("authPassword").value = "";
    setTimeout(()=> $("authUsername").focus(), 50);
  }

  function closeAuth(){
    $("authOverlay").classList.remove("open");
    $("authOverlay").setAttribute("aria-hidden", "true");
  }

  function setAuthTab(mode){
    authMode = mode;
    $("tabLogin").classList.toggle("active", mode === "login");
    $("tabRegister").classList.toggle("active", mode === "register");
    $("btnAuthSubmit").textContent = (mode === "login") ? "Login" : "Register";
    $("authPassword").setAttribute("autocomplete", mode === "login" ? "current-password" : "new-password");
  }

  function authError(msg){
    $("authError").style.display = "";
    $("authError").textContent = msg;
  }

  async function authSubmit(){
    const username = $("authUsername").value.trim();
    const password = $("authPassword").value;

    $("authError").style.display = "none";
    $("authError").textContent = "";

    try{
      if (authMode === "register") {
        await api("/api/register", "POST", {username, password});
        // –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –ª–æ–≥–∏–Ω–∏–º
        const data = await api("/api/login", "POST", {username, password});
        token = data.token;
        me = data.username;
      } else {
        const data = await api("/api/login", "POST", {username, password});
        token = data.token;
        me = data.username;
      }

      localStorage.setItem("token", token);
      localStorage.setItem("username", me);

      setWhoami();
      closeAuth();
      addSystem(`‚úÖ Logged in as ${me}`);

      await refreshChats();
      if (!chats.find(c => c.id === activeChatId)) activeChatId = "general";
      selectChat(activeChatId);

    }catch(e){
      authError(e.message);
    }
  }

  // ---- popovers ----
  function closePopovers(){
    $("popGroup").classList.remove("open");
    $("popDM").classList.remove("open");
  }
  function togglePopover(id){
    const el = $(id);
    const isOpen = el.classList.contains("open");
    closePopovers();
    if (!isOpen) el.classList.add("open");
  }

  document.addEventListener("click", (e) => {
    const groupWrap = $("btnOpenCreateGroup").parentElement;
    const dmWrap = $("btnOpenCreateDM").parentElement;
    if (!groupWrap.contains(e.target) && !dmWrap.contains(e.target)) closePopovers();
  });

  // ---- chats ----
  function renderChatList() {
    const list = $("chatlist");
    list.innerHTML = "";

    const ordered = [...chats].sort((a,b) => (a.id === "general" ? -1 : 0) + (b.id === "general" ? 1 : 0));

    for (const c of ordered) {
      const item = document.createElement("div");
      item.className = "chatitem" + (c.id === activeChatId ? " active" : "");

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";
      left.style.minWidth = "0";

      let title = c.title;
      let typeLabel = c.type;

      if (c.type === "dm" && c.title.startsWith("dm:")) {
        const parts = c.title.slice(3).split("|");
        const other = parts[0] === me ? parts[1] : parts[0];
        title = `DM: ${other}`;
      }

      const t1 = document.createElement("div");
      t1.className = "title";
      t1.textContent = title;

      const t2 = document.createElement("div");
      t2.className = "sub";
      t2.textContent = c.id;

      left.appendChild(t1);
      left.appendChild(t2);

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = typeLabel;

      item.appendChild(left);
      item.appendChild(badge);

      item.onclick = () => selectChat(c.id);
      list.appendChild(item);
    }
  }

  async function refreshChats() {
    if (!token) {
      addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ Login.");
      return;
    }
    const data = await api(`/api/chats?token=${encodeURIComponent(token)}`);
    chats = data.chats || [];
    if (!chats.find(c => c.id === "general")) {
      chats.push({id:"general", type:"group", title:"general", created_at: 0});
    }
    renderChatList();
  }

  async function createGroupChat(){
    if (!token) return openAuth("login");
    const title = $("groupTitle").value.trim();
    if (!title) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞.");
    const data = await api(`/api/chats?token=${encodeURIComponent(token)}`, "POST", {title});
    $("groupTitle").value = "";
    closePopovers();
    addSystem(`‚úÖ Created: ${data.chat.title}`);
    await refreshChats();
    selectChat(data.chat.id);
  }

  async function createDM(){
    if (!token) return openAuth("login");
    const username = $("dmUser").value.trim();
    if (!username) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ username.");
    const data = await api(`/api/chats/dm?token=${encodeURIComponent(token)}`, "POST", {username});
    $("dmUser").value = "";
    closePopovers();
    addSystem(`‚úÖ ${data.chat.title}`);
    await refreshChats();
    selectChat(data.chat.id);
  }

  function selectChat(chatId) {
    activeChatId = chatId;
    localStorage.setItem("activeChatId", activeChatId);

    const found = chats.find(c => c.id === chatId);
    if (found) {
      activeChatTitle = found.title;
      if (found.type === "dm" && found.title.startsWith("dm:")) {
        const parts = found.title.slice(3).split("|");
        const other = parts[0] === me ? parts[1] : parts[0];
        activeChatTitle = `DM: ${other}`;
      }
    } else {
      activeChatTitle = chatId;
    }

    $("msgs").innerHTML = "";
    addSystem(`üìå Chat: ${activeChatTitle}`);

    renderChatList();
    connectWS();
    loadHistory().catch(err => addSystem("‚ùå " + err.message));
  }

  // ---- messages ----
  async function loadHistory() {
    if (!token) return openAuth("login");
    $("msgs").innerHTML = "";
    addSystem(`üì• Loading: ${activeChatTitle}...`);
    const data = await api(`/api/messages?token=${encodeURIComponent(token)}&chat_id=${encodeURIComponent(activeChatId)}`);
    $("msgs").innerHTML = "";
    for (const m of data.messages) addMsg(m);
  }

  function connectWS() {
    if (!token) return;

    if (ws) ws.close();
    const proto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${proto}://${location.host}/ws?token=${encodeURIComponent(token)}&chat_id=${encodeURIComponent(activeChatId)}`);

    ws.onopen = () => setStatus(`üü¢ WS ‚Ä¢ ${activeChatTitle}`);
    ws.onclose = () => setStatus("üî¥ WS disconnected");
    ws.onerror = () => setStatus("‚ö†Ô∏è WS error");

    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      if (data.type === "message" && data.chat_id === activeChatId) addMsg(data);
    };
  }

  function send() {
    const text = $("text").value.trim();
    if (!text) return;
    if (!token) return openAuth("login");
    if (!ws || ws.readyState !== 1) return addSystem("‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WS");
    ws.send(JSON.stringify({type:"message", text}));
    $("text").value = "";
  }

  function logout(){
    token = ""; me = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    localStorage.removeItem("activeChatId");

    if (ws) ws.close();
    ws = null;

    chats = [];
    activeChatId = "general";
    activeChatTitle = "general";

    $("chatlist").innerHTML = "";
    $("msgs").innerHTML = "";
    setStatus("");
    setWhoami();
    addSystem("üëã Logged out");
  }

  // ---- wiring ----
  $("btnOpenAuth").onclick = () => openAuth("login");
  $("btnLogout").onclick = () => logout();

  $("tabLogin").onclick = () => setAuthTab("login");
  $("tabRegister").onclick = () => setAuthTab("register");
  $("btnCloseAuth").onclick = () => closeAuth();
  $("authOverlay").addEventListener("click", (e)=>{ if (e.target === $("authOverlay")) closeAuth(); });

  $("btnAuthSubmit").onclick = () => authSubmit();
  $("authPassword").addEventListener("keydown", (e)=>{ if (e.key === "Enter") authSubmit(); });

  $("btnOpenCreateGroup").onclick = () => {
    if (!token) return openAuth("login");
    togglePopover("popGroup");
    setTimeout(()=> $("groupTitle").focus(), 30);
  };
  $("btnCloseGroup").onclick = () => closePopovers();
  $("btnCreateGroup").onclick = () => createGroupChat().catch(e=> addSystem("‚ùå " + e.message));
  $("groupTitle").addEventListener("keydown", (e)=>{ if (e.key === "Enter") $("btnCreateGroup").click(); });

  $("btnOpenCreateDM").onclick = () => {
    if (!token) return openAuth("login");
    togglePopover("popDM");
    setTimeout(()=> $("dmUser").focus(), 30);
  };
  $("btnCloseDM").onclick = () => closePopovers();
  $("btnCreateDM").onclick = () => createDM().catch(e=> addSystem("‚ùå " + e.message));
  $("dmUser").addEventListener("keydown", (e)=>{ if (e.key === "Enter") $("btnCreateDM").click(); });

  $("btnRefreshChats").onclick = () => refreshChats().catch(e => addSystem("‚ùå " + e.message));
  $("btnLoadHistory").onclick = () => loadHistory().catch(e => addSystem("‚ùå " + e.message));

  $("btnSend").onclick = () => send();
  $("text").addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

  // ---- restore session ----
  setWhoami();
  if (token) {
    addSystem(`üîÅ Restoring session for ${me || "user"}...`);
    refreshChats()
      .then(() => {
        if (!chats.find(c => c.id === activeChatId)) activeChatId = "general";
        selectChat(activeChatId);
      })
      .catch(() => {});
  } else {
    addSystem("üëã –ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ Login / Register —Å–≤–µ—Ä—Ö—É.");
    // –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É:
    // openAuth("login");
  }
</script>
</body>
</html>
