<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Messenger</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --border:#24304a;
      --muted:rgba(230,238,252,.85);
      --btn:#1b2742;
      --shadow: 0 18px 50px rgba(0,0,0,.5);
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, Arial;
      background: var(--bg);
      color:#e6eefc;
      overflow: hidden;
    }
    .wrap{ height: 100dvh; padding: 16px; display:flex; align-items:center; justify-content:center; }
    .card{
      width: min(1100px, 100%);
      height: calc(100dvh - 32px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 0;
    }
    .top{
      flex: 0 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      padding: calc(10px + env(safe-area-inset-top)) 12px 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(18,26,43,.92);
      backdrop-filter: blur(6px);
      z-index: 50;
    }
    .top-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand{ font-weight:700; white-space:nowrap; }
    .pill{
      font-size:12px; opacity:.95;
      padding: 4px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#0b1220;
      white-space:nowrap;
      max-width: 46vw;
      overflow:hidden;
      text-overflow: ellipsis;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .small{ font-size:12px; opacity:.85; color: var(--muted); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }

    .avatar{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      object-fit: cover;
      display:none;
    }
    .avatar.show{ display:inline-block; }

    .grid{
      flex: 1 1 auto;
      min-height: 0;
      display:grid;
      grid-template-columns: 320px 1fr;
    }

    .sidebar{
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,.08);
      min-height: 0;
      display:flex;
      flex-direction: column;
      position: relative;
      z-index: 30;
    }
    .sidebar-inner{
      min-height: 0;
      display:flex;
      flex-direction: column;
      padding: 12px;
      gap: 10px;
    }
    .iconbar{ display:flex; gap:8px; align-items:center; }
    .iconbtn{
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .iconbtn:hover{ filter:brightness(1.08); }
    .iconbtn:active{ transform: translateY(1px); }

    input, textarea{
      width: 100%;
      background: rgba(255,255,255,.03);
      color:#e6eefc;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    input:focus, textarea:focus{
      border-color: rgba(140,170,255,.55);
      box-shadow: 0 0 0 3px rgba(120,160,255,.10);
    }
    .sep{ height:1px; background: var(--border); opacity:.7; margin: 4px 0; }

    .chatlist{
      min-height: 0;
      overflow:auto;
      display:flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 2px;
    }
    .chatitem{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor:pointer;
      user-select:none;
      position: relative;
    }
    .chatitem:hover{ filter:brightness(1.08); }
    .chatitem.active{
      outline: 2px solid rgba(120,160,255,.25);
      background: rgba(120,160,255,.08);
    }
    .chatitem .left{ min-width:0; }
    .chatitem .title{ font-weight:700; white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .chatitem .sub{ font-size:12px; opacity:.8; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow: ellipsis; }
    .badge{
      font-size: 12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.12);
      padding: 4px 8px;
      border-radius: 999px;
      opacity: .9;
      flex: 0 0 auto;
    }
    .unread{
      font-size: 12px;
      border:1px solid rgba(120,160,255,.25);
      background: rgba(120,160,255,.12);
      padding: 4px 8px;
      border-radius: 999px;
      flex: 0 0 auto;
      font-weight: 700;
    }
    .trash{
      width: 34px; height: 34px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: rgba(255,91,91,.10);
      color: #ffdede;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      flex: 0 0 auto;
    }

    .chat{
      min-height: 0;
      display:flex;
      flex-direction: column;
      position: relative;
    }
    .msgs{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .msg{
      max-width: min(720px, 92%);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
    }
    .msg.me{
      align-self:flex-end;
      background: rgba(120,160,255,.10);
      border-color: rgba(120,160,255,.20);
    }
    .meta{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
      opacity: .9;
    }
    .meta b{ color:#e6eefc; opacity: .95; }
    .edited{
      font-size: 11px;
      opacity: .75;
      margin-left: 8px;
    }
    .deleted{
      opacity: .7;
      font-style: italic;
    }

    .media{
      margin-top: 6px;
      border-radius: 12px;
      overflow:hidden;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
    }
    .media img, .media video{
      width: 100%;
      max-height: 420px;
      object-fit: cover;
      display:block;
    }

    .to-bottom{
      position:absolute;
      right: 12px;
      bottom: 72px;
      width: 42px;
      height: 42px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      display:grid;
      place-items:center;
      cursor:pointer;
      opacity:0;
      pointer-events:none;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .to-bottom.show{
      opacity: 1;
      pointer-events:auto;
      transform: translateY(0);
    }

    .composer{
      border-top: 1px solid var(--border);
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px;
      background: rgba(0,0,0,.08);
    }
    .composer button{
      width: 44px; height: 44px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      font-size: 18px;
    }
    .composer input{
      flex: 1 1 auto;
      height: 44px;
      border-radius: 12px;
    }
    .hold{
      border-color: rgba(255,91,91,.35) !important;
      background: rgba(255,91,91,.12) !important;
    }

    .statusbar{
      border-top: 1px solid var(--border);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      background: rgba(0,0,0,.08);
    }
    .typing{
      margin-left: 10px;
      opacity: .85;
    }

    .drawer-backdrop{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 20;
    }
    .drawer-backdrop.open{ display:block; }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .sidebar{
        position: fixed;
        left: 0; top: 0; bottom: 0;
        width: min(92vw, 360px);
        transform: translateX(-110%);
        transition: transform .25s ease;
        box-shadow: var(--shadow);
      }
      .sidebar.open{ transform: translateX(0); }
    }

    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      z-index: 60;
    }
    .overlay.open{ display:flex; }
    .modal{
      width: min(440px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .tabs{ display:flex; gap: 8px; }
    .tab{
      padding: 8px 12px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      opacity: .9;
    }
    .tab.active{
      background: rgba(120,160,255,.10);
      border-color: rgba(120,160,255,.25);
      opacity: 1;
      font-weight: 700;
    }
    .xbtn{
      width: 40px; height: 40px;
      border-radius: 10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
    }
    .modal-body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .err{
      display:none;
      border: 1px solid rgba(255,91,91,.35);
      background: rgba(255,91,91,.10);
      color:#ffdede;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .btnrow button{
      width: 100%;
      height: 44px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
      font-weight: 700;
    }
    .danger{
      border-color: rgba(255,91,91,.35) !important;
      background: rgba(255,91,91,.10) !important;
      color:#ffdede !important;
    }

    .sheet-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 55;
    }
    .sheet-overlay.open{ display:flex; }
    .sheet{
      width: min(560px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheet-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    .sheet-body{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .sheet-actions{ display:flex; gap:10px; }
    .sheet-actions button{
      flex: 1 1 auto;
      height: 44px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
      font-weight: 700;
    }

    .ctx{
      position: fixed;
      z-index: 80;
      display:none;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      min-width: 200px;
      overflow:hidden;
    }
    .ctx.open{ display:block; }
    .ctx button{
      width:100%;
      padding: 10px 12px;
      background: transparent;
      border:0;
      color:#e6eefc;
      text-align:left;
      cursor:pointer;
    }
    .ctx button:hover{ background: rgba(255,255,255,.05); }

    .voice{ display:flex; align-items:center; gap:10px; max-width: 420px; }
    .voice .play{
      width:38px;height:38px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      flex: 0 0 auto;
    }
    .voice .wave{
      flex: 1 1 auto;
      min-width: 160px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .voice canvas{
      width: 100%;
      height: 34px;
      display:block;
      border-radius: 10px;
      background: rgba(0,0,0,.12);
      border: 1px solid var(--border);
      cursor: pointer;
    }
    .voice .time{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      opacity: .85;
      color: var(--muted);
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="top-left">
          <div class="iconbtn" id="btnToggleSidebar" title="–ú–µ–Ω—é">‚ò∞</div>
          <div style="min-width:0">
            <div class="brand">Mini Messenger</div>
            <div class="small">FastAPI + Render + Postgres + Cloudinary</div>
          </div>
        </div>
        <div class="row">
          <div class="pill" id="whoami">
            <img id="topAvatar" class="avatar" alt="avatar"/>
            <span id="whoText">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
          </div>
          <button class="btn" id="btnProfile" type="button" style="display:none;">–ü—Ä–æ—Ñ–∏–ª—å</button>
          <button class="btn" id="btnOpenAuth" type="button">–í–æ–π—Ç–∏</button>
          <button class="btn" id="btnLogout" type="button" style="display:none;">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <div class="grid">
        <div class="sidebar" id="sidebar">
          <div class="sidebar-inner">
            <div class="row" style="justify-content:space-between;">
              <div><b>Chats</b></div>
              <div class="iconbar">
                <div class="iconbtn" id="btnOpenCreateGroup" title="New group chat">‚ûï</div>
                <div class="iconbtn" id="btnOpenCreateDM" title="New DM">üí¨</div>
                <div class="iconbtn" id="btnRefreshChats" title="Refresh chats">‚ü≥</div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row">
              <button class="btn" id="btnLoadHistory" type="button">Load history</button>
            </div>

            <div class="sep"></div>

            <div class="chatlist" id="chatlist"></div>

            <div class="small" style="margin-top:auto;">
              ‚ûï group ‚Ä¢ üí¨ DM ‚Ä¢ üóë delete chat ‚Ä¢ –ü–ö–ú/long-press msg ‚Üí Edit/Delete ‚Ä¢ typing‚Ä¶ ‚Ä¢ unread badges
            </div>
          </div>
        </div>

        <div class="chat">
          <div class="msgs" id="msgs"></div>
          <div class="to-bottom" id="btnToBottom" title="–í–Ω–∏–∑">‚¨áÔ∏è</div>

          <div class="composer">
            <button id="btnAttach" type="button" title="–§–æ—Ç–æ/–í–∏–¥–µ–æ/–ê—É–¥–∏–æ">üìé</button>
            <input id="file" type="file" accept="image/*,video/*,audio/*" style="display:none" />
            <button id="btnRecHold" type="button" title="Hold to record">üéôÔ∏è</button>
            <input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ." />
            <button id="btnSend" type="button">Send</button>
          </div>

          <div class="statusbar">
            <div class="small">
              <span id="status">‚Äî</span>
              <span class="typing" id="typing"></span>
            </div>
            <div class="pill" id="net">offline</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH -->
  <div class="overlay" id="authOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <div class="tabs">
          <div class="tab active" id="tabLogin">Login</div>
          <div class="tab" id="tabRegister">Register</div>
        </div>
        <button class="xbtn" id="btnCloseAuth" type="button">‚úï</button>
      </div>
      <div class="modal-body">
        <input id="authUsername" placeholder="username (3-20: a-z 0-9 _)" autocomplete="username" />
        <input id="authPassword" placeholder="password (–º–∏–Ω 6)" type="password" autocomplete="current-password" />
        <div class="err" id="authError"></div>
        <div class="btnrow"><button id="btnAuthSubmit" type="button">Login</button></div>
        <div class="small">–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      </div>
    </div>
  </div>

  <!-- CREATE SHEET -->
  <div class="sheet-overlay" id="sheetOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-top">
        <b id="sheetTitle">–°–æ–∑–¥–∞—Ç—å</b>
        <button class="xbtn" id="btnCloseSheet" type="button">‚úï</button>
      </div>
      <div class="sheet-body">
        <input id="sheetInput" placeholder="" />
        <div class="sheet-actions">
          <button id="btnSheetOk" type="button">OK</button>
          <button id="btnSheetCancel" type="button" class="danger">Cancel</button>
        </div>
        <div class="small" id="sheetHint" style="opacity:.85;"></div>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="sheet-overlay" id="profileOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-top">
        <b>–ü—Ä–æ—Ñ–∏–ª—å</b>
        <button class="xbtn" id="btnCloseProfile" type="button">‚úï</button>
      </div>
      <div class="sheet-body">
        <div class="small">–ê–≤–∞—Ç–∞—Ä</div>
        <input id="avatarFile" type="file" accept="image/*"/>
        <button id="btnUploadAvatar" class="btn" type="button">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <div class="small" id="profileHint">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- VOICE PREVIEW -->
  <div class="overlay" id="voicePreviewOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <b>–ì–æ–ª–æ—Å–æ–≤–æ–µ</b>
        <button class="xbtn" id="btnCloseVoicePreview" type="button">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="voicePreviewPlayer"></div>
        <div class="btnrow" style="display:flex; gap:10px;">
          <button id="btnSendVoiceNow" type="button" style="flex:1;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          <button id="btnCancelVoiceNow" type="button" class="danger" style="flex:1;">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="small" id="voicePreviewHint">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- CONTEXT MENU -->
  <div class="ctx" id="ctxMenu">
    <button id="ctxEdit">Edit</button>
    <button id="ctxDeleteMe">Delete for me</button>
    <button id="ctxDeleteAll">Delete for all</button>
    <button id="ctxCancel" class="danger">Cancel</button>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let avatarUrl = localStorage.getItem("avatar_url") || "";

  // GLOBAL WS (one connection per user)
  let ws = null;

  let chats = [];
  let activeChatId = localStorage.getItem("activeChatId") || "";
  let activeChatTitle = "";
  const msgElById = new Map();
  let lastMsgId = 0;

  function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }

  // --- sound notify ---
  let audioCtx = null;
  function beep(){
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const ctx = audioCtx;
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine"; o.frequency.value = 880;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      const t = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
      o.start(t); o.stop(t + 0.2);
    }catch(_){}
  }

  // --- Drawer ---
  const sidebar = $("sidebar");
  const backdrop = $("drawerBackdrop");
  function openSidebar(){ sidebar.classList.add("open"); backdrop.classList.add("open"); }
  function closeSidebar(){ sidebar.classList.remove("open"); backdrop.classList.remove("open"); }
  function toggleSidebar(){ sidebar.classList.contains("open") ? closeSidebar() : openSidebar(); }

  // --- Scroll + read ---
  const toBottomBtn = $("btnToBottom");
  function isNearBottom(el, px=160){
    return (el.scrollHeight - el.scrollTop - el.clientHeight) < px;
  }
  function scrollToBottom(el){ el.scrollTop = el.scrollHeight; }
  function updateToBottom(){
    const box = $("msgs");
    toBottomBtn.classList.toggle("show", !isNearBottom(box));
    if (isNearBottom(box)) maybeMarkRead();
  }

  function setStatus(s){ $("status").textContent = s || "‚Äî"; }
  function setNet(s){ $("net").textContent = s || "offline"; }

  function addSystem(text){
    const box = $("msgs");
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `
      <div class="meta"><b>System</b><span>‚Äî</span></div>
      <div>${String(text||"")}</div>
    `;
    box.appendChild(div);
    scrollToBottom(box);
    updateToBottom();
  }

  function fmtTs(ts){
    try{
      const d = new Date((ts||0)*1000);
      return d.toLocaleString(undefined, {hour:"2-digit", minute:"2-digit"});
    }catch{ return "‚Äî"; }
  }

  async function api(path, method="GET", body=null){
    const opts = { method, headers: {} };
    if (token) opts.headers["Authorization"] = `Bearer ${token}`;
    if (body){
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(path, opts);
    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { data = { detail: raw }; }
    if (!res.ok) throw new Error((data && data.detail) ? String(data.detail) : `${res.status} ${res.statusText}`);
    return data;
  }

  // =========================
  // Voice waveform player
  // =========================
  const VOICE = { peaksCache: new Map(), audioCache: new Map(), players: new Set() };
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function fmtClock(sec){
    sec = Math.max(0, sec || 0);
    const m = String(Math.floor(sec/60)).padStart(1,"0");
    const s = String(Math.floor(sec%60)).padStart(2,"0");
    return `${m}:${s}`;
  }
  async function getPeaks(url, samples = 120){
    if (VOICE.peaksCache.has(url)) return VOICE.peaksCache.get(url);
    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error(`waveform fetch failed: ${res.status}`);
    const buf = await res.arrayBuffer();
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) throw new Error("AudioContext not supported");
    const ctx = new Ctx();
    const audioBuf = await ctx.decodeAudioData(buf.slice(0));
    try{ await ctx.close(); }catch(_){}
    const ch = audioBuf.getChannelData(0);
    const block = Math.floor(ch.length / samples) || 1;
    const peaks = new Float32Array(samples);
    for (let i=0;i<samples;i++){
      let start = i * block;
      let end = Math.min(ch.length, start + block);
      let max = 0;
      for (let j=start;j<end;j++){
        const v = Math.abs(ch[j]);
        if (v > max) max = v;
      }
      peaks[i] = max;
    }
    let pmax = 0;
    for (let i=0;i<peaks.length;i++) pmax = Math.max(pmax, peaks[i]);
    const k = pmax > 0 ? (1 / pmax) : 1;
    for (let i=0;i<peaks.length;i++) peaks[i] *= k;
    VOICE.peaksCache.set(url, peaks);
    return peaks;
  }
  function getOrCreateAudio(url){
    if (VOICE.audioCache.has(url)) return VOICE.audioCache.get(url);
    const a = new Audio(url);
    a.preload = "metadata";
    a.crossOrigin = "anonymous";
    VOICE.audioCache.set(url, a);
    return a;
  }
  function stopAllExcept(except){
    for (const p of VOICE.players){
      if (p !== except) p.stop();
    }
  }
  function drawWave(canvas, peaks, progress01){
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 300;
    const cssH = canvas.clientHeight || 34;
    const W = Math.floor(cssW * dpr);
    const H = Math.floor(cssH * dpr);
    if (canvas.width !== W) canvas.width = W;
    if (canvas.height !== H) canvas.height = H;
    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,W,H);
    const n = peaks.length;
    const gap = Math.floor(2 * dpr);
    const barW = Math.max(1, Math.floor((W - gap*(n-1)) / n));
    const mid = Math.floor(H/2);
    const maxBar = Math.floor(H * 0.78);
    const progX = Math.floor(W * clamp(progress01, 0, 1));
    for (let i=0;i<n;i++){
      const x = i * (barW + gap);
      const amp = peaks[i];
      const h = Math.max(2*dpr, Math.floor(amp * maxBar));
      const y = mid - Math.floor(h/2);
      const filled = (x + barW) <= progX;
      ctx.fillStyle = filled ? "rgba(230,238,252,.95)" : "rgba(230,238,252,.35)";
      ctx.fillRect(x, y, barW, h);
    }
  }
  function createVoicePlayer(url){
    const root = document.createElement("div");
    root.className = "voice";
    const btn = document.createElement("div");
    btn.className = "play";
    btn.textContent = "‚ñ∂";
    const waveWrap = document.createElement("div");
    waveWrap.className = "wave";
    const canvas = document.createElement("canvas");
    canvas.height = 34;
    const timeRow = document.createElement("div");
    timeRow.className = "time";
    const left = document.createElement("span");
    left.textContent = "0:00";
    const right = document.createElement("span");
    right.textContent = "0:00";
    timeRow.appendChild(left);
    timeRow.appendChild(right);
    waveWrap.appendChild(canvas);
    waveWrap.appendChild(timeRow);
    root.appendChild(btn);
    root.appendChild(waveWrap);

    const audio = getOrCreateAudio(url);

    const player = {
      root, btn, canvas, audio,
      peaks: null,
      raf: 0,
      destroyed: false,
      async init(){
        try{
          this.peaks = await getPeaks(url, 120);
          if (this.destroyed) return;
          drawWave(this.canvas, this.peaks, 0);
        }catch(_){
          this.peaks = new Float32Array(120);
          for (let i=0;i<this.peaks.length;i++) this.peaks[i] = 0.15;
          drawWave(this.canvas, this.peaks, 0);
        }
      },
      setBtn(){ this.btn.textContent = this.audio.paused ? "‚ñ∂" : "‚è∏"; },
      tick(){
        if (this.destroyed) return;
        const dur = this.audio.duration || 0;
        const cur = this.audio.currentTime || 0;
        left.textContent = fmtClock(cur);
        right.textContent = dur ? fmtClock(dur) : "0:00";
        const p = dur ? (cur / dur) : 0;
        if (this.peaks) drawWave(this.canvas, this.peaks, p);
        this.raf = requestAnimationFrame(()=> this.tick());
      },
      playPause(){
        stopAllExcept(this);
        if (this.audio.paused) this.audio.play().catch(()=>{});
        else this.audio.pause();
      },
      stop(){
        try{ this.audio.pause(); }catch(_){}
        try{ this.audio.currentTime = 0; }catch(_){}
        this.setBtn();
        if (this.peaks) drawWave(this.canvas, this.peaks, 0);
        if (this.raf) cancelAnimationFrame(this.raf);
        this.raf = 0;
      },
      seekByClientX(clientX){
        const r = this.canvas.getBoundingClientRect();
        const x = clamp(clientX - r.left, 0, r.width);
        const p = r.width ? (x / r.width) : 0;
        const dur = this.audio.duration || 0;
        if (dur) this.audio.currentTime = p * dur;
      },
      destroy(){
        this.destroyed = true;
        this.stop();
        VOICE.players.delete(this);
      }
    };

    btn.onclick = () => player.playPause();
    canvas.addEventListener("click", (e)=> player.seekByClientX(e.clientX));
    audio.addEventListener("loadedmetadata", ()=>{ right.textContent = fmtClock(audio.duration || 0); });
    audio.addEventListener("play", ()=>{ player.setBtn(); if (!player.raf) player.tick(); });
    audio.addEventListener("pause", ()=>{
      player.setBtn();
      if (player.raf) cancelAnimationFrame(player.raf);
      player.raf = 0;
      const dur = audio.duration || 0;
      const cur = audio.currentTime || 0;
      const p = dur ? (cur/dur) : 0;
      if (player.peaks) drawWave(canvas, player.peaks, p);
    });
    audio.addEventListener("ended", ()=> player.stop());

    VOICE.players.add(player);
    player.init();
    return player;
  }

  // =========================
  // AUTH
  // =========================
  let authMode = "login";
  let authBusy = false;

  function showAuthError(msg){
    const el = $("authError");
    el.textContent = msg || "–û—à–∏–±–∫–∞";
    el.style.display = "block";
  }
  function hideAuthError(){
    const el = $("authError");
    el.textContent = "";
    el.style.display = "none";
  }
  function setAuthTab(mode){
    authMode = mode;
    $("tabLogin").classList.toggle("active", mode==="login");
    $("tabRegister").classList.toggle("active", mode==="register");
    $("btnAuthSubmit").textContent = (mode==="login") ? "Login" : "Register";
    hideAuthError();
  }
  function openAuth(mode="login"){
    setAuthTab(mode);
    $("authOverlay").classList.add("open");
    $("authOverlay").setAttribute("aria-hidden","false");
    $("authUsername").value = me || $("authUsername").value || "";
    $("authPassword").value = "";
    setTimeout(()=> $("authUsername").focus(), 50);
  }
  function closeAuth(){
    $("authOverlay").classList.remove("open");
    $("authOverlay").setAttribute("aria-hidden","true");
  }
  async function authSubmit(){
    if (authBusy) return;
    hideAuthError();
    const username = $("authUsername").value.trim();
    const password = $("authPassword").value;
    if (!username) return showAuthError("–í–≤–µ–¥–∏—Ç–µ username.");
    if (!password) return showAuthError("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å.");
    authBusy = true;
    $("btnAuthSubmit").disabled = true;
    $("btnAuthSubmit").textContent = (authMode==="login") ? "Logging in‚Ä¶" : "Registering‚Ä¶";
    try{
      const data = await api(authMode==="login" ? "/api/login" : "/api/register", "POST", {username, password});
      token = data.token;
      me = data.username;
      localStorage.setItem("token", token);
      localStorage.setItem("username", me);
      await refreshMe();
      setWhoami();
      closeAuth();
      addSystem(`‚úÖ Logged in as ${me}`);

      connectWS_GLOBAL();            // <‚Äî IMPORTANT
      await refreshChats(true);      // load chats + choose active + load history
    }catch(e){
      showAuthError(String(e.message || e));
    }finally{
      authBusy = false;
      $("btnAuthSubmit").disabled = false;
      $("btnAuthSubmit").textContent = (authMode==="login") ? "Login" : "Register";
    }
  }

  async function refreshMe(){
    if (!token) return;
    const data = await api("/api/me");
    avatarUrl = data.avatar_url || "";
    localStorage.setItem("avatar_url", avatarUrl || "");
  }

  // =========================
  // Typing (GLOBAL WS)
  // =========================
  const typingState = new Map(); // username -> bool (only for active chat)
  function renderTyping(){
    const names = [];
    for (const [u, on] of typingState.entries()){
      if (on && u !== me) names.push(u);
    }
    $("typing").textContent = names.length ? `${names.join(", ")} –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶` : "";
  }

  let typingTimer = null;
  let typingSent = false;

  function wsSendTyping(isTyping){
    if (!ws || ws.readyState !== 1) return;
    if (!activeChatId) return;
    try{
      ws.send(JSON.stringify({
        type: "typing",
        chat_id: activeChatId,
        is_typing: !!isTyping
      }));
    }catch(_){}
  }

  function onLocalTyping(){
    if (!token || !activeChatId) return;
    if (!typingSent){
      typingSent = true;
      wsSendTyping(true);
    }
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=>{
      typingSent = false;
      wsSendTyping(false);
    }, 900);
  }

  // =========================
  // GLOBAL WS connect
  // =========================
  function connectWS_GLOBAL(){
    if (!token) return;

    if (ws){
      try{ ws.close(); }catch{}
      ws = null;
    }

    const proto = location.protocol === "https:" ? "wss:" : "ws:";
    const url = `${proto}//${location.host}/ws/user?token=${encodeURIComponent(token)}`;

    setNet("connecting‚Ä¶");
    ws = new WebSocket(url);

    ws.onopen = () => setNet("online");
    ws.onclose = () => setNet("offline");
    ws.onerror = () => setNet("offline");

    ws.onmessage = (ev) => {
      let data = null;
      try{ data = JSON.parse(ev.data); }catch{ return; }

      // typing (server sends for any chat)
      if (data.type === "typing"){
        // show typing only in active chat
        if (data.chat_id === activeChatId){
          typingState.set(data.username, !!data.is_typing);
          renderTyping();
        }
        return;
      }

      // new message for ANY chat
      if (data.type === "message"){
        if (data.sender && data.sender !== me) beep();

        // if active chat -> add to UI
        if (data.chat_id === activeChatId){
          addMsg(data);
        }

        // always refresh chat list to update unread badges (no polling!)
        refreshChats(false).catch(()=>{});
        return;
      }

      // edited
      if (data.type === "message_edited"){
        if (data.chat_id === activeChatId){
          applyEdited(data.id, data.text, true);
        }
        return;
      }

      // deleted for all
      if (data.type === "message_deleted_all"){
        if (data.chat_id === activeChatId){
          applyDeletedAll(data.id);
        }
        refreshChats(false).catch(()=>{});
        return;
      }

      // chat deleted
      if (data.type === "chat_deleted"){
        refreshChats(true).catch(()=>{});
        if (data.chat_id === activeChatId){
          $("msgs").innerHTML = "";
          addSystem("üóë –≠—Ç–æ—Ç —á–∞—Ç —É–¥–∞–ª—ë–Ω.");
        }
        return;
      }
    };
  }

  // =========================
  // Sheets
  // =========================
  const sheet = {
    overlay: $("sheetOverlay"),
    title: $("sheetTitle"),
    input: $("sheetInput"),
    hint: $("sheetHint"),
    ok: $("btnSheetOk"),
    mode: null
  };
  function openSheet(mode){
    if (!token) return openAuth("login");
    sheet.mode = mode;
    sheet.overlay.classList.add("open");
    sheet.overlay.setAttribute("aria-hidden","false");
    if (mode === "group"){
      sheet.title.textContent = "–ù–æ–≤—ã–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç";
      sheet.input.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: work)";
      sheet.hint.textContent = "–°–æ–∑–¥–∞—Å—Ç —á–∞—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç —Ç–µ–±—è –≤ –Ω–µ–≥–æ.";
      sheet.ok.textContent = "Create";
    } else {
      sheet.title.textContent = "–ù–æ–≤—ã–π DM";
      sheet.input.placeholder = "Username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
      sheet.hint.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.";
      sheet.ok.textContent = "Open DM";
    }
    sheet.input.value = "";
    setTimeout(()=> sheet.input.focus(), 50);
  }
  function closeSheet(){
    sheet.overlay.classList.remove("open");
    sheet.overlay.setAttribute("aria-hidden","true");
    sheet.mode = null;
  }

  const profile = { overlay: $("profileOverlay") };
  function openProfile(){
    if (!token) return openAuth("login");
    $("profileHint").textContent = `@${me}`;
    profile.overlay.classList.add("open");
    profile.overlay.setAttribute("aria-hidden","false");
  }
  function closeProfile(){
    profile.overlay.classList.remove("open");
    profile.overlay.setAttribute("aria-hidden","true");
  }

  // =========================
  // Voice hold-to-record + preview
  // =========================
  const recBtn = $("btnRecHold");
  let rec = { active:false, mr:null, chunks:[], stream:null };
  let preview = { blob:null, file:null, url:"" };

  function openVoicePreview(){
    $("voicePreviewOverlay").classList.add("open");
    $("voicePreviewOverlay").setAttribute("aria-hidden","false");
    const holder = $("voicePreviewPlayer");
    holder.innerHTML = "";
    const player = createVoicePlayer(preview.url);
    holder.appendChild(player.root);
    $("voicePreviewHint").textContent = "–ü—Ä–æ—Å–ª—É—à–∞–π –∏ –æ—Ç–ø—Ä–∞–≤—å / –æ—Ç–º–µ–Ω–∞.";
  }
  function closeVoicePreview(){
    $("voicePreviewOverlay").classList.remove("open");
    $("voicePreviewOverlay").setAttribute("aria-hidden","true");
    $("voicePreviewPlayer").innerHTML = "";
  }
  function clearPreview(){
    try{ if (preview.url) URL.revokeObjectURL(preview.url); }catch(_){}
    preview = { blob:null, file:null, url:"" };
  }

  async function startHoldRec(){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");
    if (!navigator.mediaDevices?.getUserMedia) return addSystem("‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.");
    if (!window.MediaRecorder) return addSystem("‚ö†Ô∏è MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
    try{
      clearPreview();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mr = new MediaRecorder(stream);

      rec.active = true;
      rec.mr = mr;
      rec.stream = stream;
      rec.chunks = [];

      recBtn.classList.add("hold");
      setStatus("üéô Recording‚Ä¶");

      mr.ondataavailable = (e) => { if (e.data?.size) rec.chunks.push(e.data); };
      mr.onstop = () => {
        try{
          const blob = new Blob(rec.chunks, { type: mr.mimeType || "audio/webm" });
          const file = new File([blob], `voice_${Date.now()}.webm`, { type: blob.type });
          preview.blob = blob;
          preview.file = file;
          preview.url = URL.createObjectURL(blob);
          openVoicePreview();
        }catch(e){
          addSystem("‚ùå " + (e.message || e));
        }finally{
          try{ rec.stream?.getTracks().forEach(t => t.stop()); }catch(_){}
          rec.stream = null; rec.mr = null; rec.chunks = [];
        }
      };

      mr.start(200);
    }catch(e){
      addSystem("‚ùå " + (e.message || e));
    }
  }
  function stopHoldRec(){
    if (!rec.active) return;
    rec.active = false;
    recBtn.classList.remove("hold");
    setStatus("‚Äî");
    try{ rec.mr?.stop(); }catch(_){}
  }

  async function uploadMedia(file, captionOverride=null){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");
    const caption = captionOverride !== null ? captionOverride : $("text").value.trim();
    const fd = new FormData();
    fd.append("chat_id", activeChatId);
    fd.append("text", caption);
    fd.append("file", file);
    setStatus("‚è´ Upload‚Ä¶");
    const res = await fetch("/api/upload", { method: "POST", headers: { "Authorization": `Bearer ${token}` }, body: fd });
    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { data = { detail: raw }; }
    if (!res.ok){ setStatus(""); throw new Error(data.detail || raw); }
    $("text").value = "";
    $("file").value = "";
    setStatus(`online ‚Ä¢ ${activeChatTitle}`);
  }

  async function sendVoiceNow(){
    if (!preview.file) return;
    try{
      setStatus("‚è´ Upload voice‚Ä¶");
      await uploadMedia(preview.file, "");
      closeVoicePreview();
      clearPreview();
    }catch(e){
      addSystem("‚ùå " + (e.message || e));
    }finally{
      setStatus(`online ‚Ä¢ ${activeChatTitle}`);
    }
  }

  // =========================
  // Avatar upload
  // =========================
  async function uploadAvatar(){
    const f = $("avatarFile").files && $("avatarFile").files[0];
    if (!f) return $("profileHint").textContent = "–í—ã–±–µ—Ä–∏ —Ñ–∞–π–ª.";
    try{
      $("profileHint").textContent = "Uploading‚Ä¶";
      const fd = new FormData();
      fd.append("file", f);
      const res = await fetch("/api/avatar", {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: fd
      });
      const raw = await res.text();
      let data = {};
      try { data = JSON.parse(raw); } catch { data = { detail: raw }; }
      if (!res.ok) throw new Error(data.detail || raw);
      avatarUrl = data.avatar_url || "";
      localStorage.setItem("avatar_url", avatarUrl || "");
      setWhoami();
      $("profileHint").textContent = "‚úÖ –ì–æ—Ç–æ–≤–æ!";
    }catch(e){
      $("profileHint").textContent = "‚ùå " + (e.message || e);
    }
  }

  // =========================
  // Chats + unread
  // =========================
  function computeChatTitle(c){
    let title = c.title || c.id;
    if (c.type === "dm" && c.title && c.title.startsWith("dm:")){
      const parts = c.title.slice(3).split("|");
      if (parts.length === 2){
        const other = parts[0] === me ? parts[1] : parts[0];
        title = `DM: ${other}`;
      }
    }
    return title;
  }
  function canDeleteChat(c){
    if (c.id === "general") return false;
    if (c.type === "dm") return true;
    return (c.created_by === me);
  }

  function renderChatList(){
    const list = $("chatlist");
    list.innerHTML = "";
    if (!chats.length){
      const div = document.createElement("div");
      div.className = "small";
      div.textContent = "–ù–µ—Ç —á–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π ‚ûï –∏–ª–∏ üí¨";
      list.appendChild(div);
      return;
    }

    for (const c of chats){
      const item = document.createElement("div");
      item.className = "chatitem" + (c.id === activeChatId ? " active" : "");

      const left = document.createElement("div");
      left.className = "left";

      const title = computeChatTitle(c);
      const t1 = document.createElement("div");
      t1.className = "title";
      t1.textContent = title;

      const t2 = document.createElement("div");
      t2.className = "sub";
      t2.textContent = c.id;

      left.appendChild(t1);
      left.appendChild(t2);

      const right = document.createElement("div");
      right.style.display = "flex";
      right.style.gap = "8px";
      right.style.alignItems = "center";

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = (c.type === "dm") ? "DM" : "GROUP";
      right.appendChild(badge);

      if (c.unread && Number(c.unread) > 0 && c.id !== activeChatId){
        const u = document.createElement("span");
        u.className = "unread";
        u.textContent = String(c.unread);
        right.appendChild(u);
      }

      if (canDeleteChat(c)){
        const del = document.createElement("div");
        del.className = "trash";
        del.textContent = "üóë";
        del.title = "–£–¥–∞–ª–∏—Ç—å —á–∞—Ç";
        del.onclick = async (e) => {
          e.stopPropagation();
          if (!confirm(`–£–¥–∞–ª–∏—Ç—å —á–∞—Ç "${title}"?`)) return;
          try{
            await api(`/api/chats/${encodeURIComponent(c.id)}`, "DELETE");
            addSystem(`üóë Deleted: ${title}`);
            await refreshChats(true);
          }catch(err){
            addSystem("‚ùå " + (err.message || err));
          }
        };
        right.appendChild(del);
      }

      item.appendChild(left);
      item.appendChild(right);

      item.onclick = () => {
        selectChat(c.id);
        if (isMobile()) closeSidebar();
      };

      list.appendChild(item);
    }
  }

  async function refreshChats(selectIfNeeded){
    if (!token){ openAuth("login"); return; }
    const data = await api("/api/chats");
    chats = (data.chats || []);
    renderChatList();

    if (!chats.length){
      activeChatId = "";
      activeChatTitle = "";
      localStorage.removeItem("activeChatId");
      $("msgs").innerHTML = "";
      addSystem("‚ÑπÔ∏è –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –∏–ª–∏ DM.");
      setStatus("");
      return;
    }

    if (selectIfNeeded){
      if (!activeChatId || !chats.find(c => c.id === activeChatId)){
        activeChatId = chats[0].id;
        localStorage.setItem("activeChatId", activeChatId);
      }
      selectChat(activeChatId);
    } else {
      // just rerender selection if needed
      renderChatList();
    }
  }

  function selectChat(chatId){
    stopAllExcept(null);
    msgElById.clear();
    lastMsgId = 0;

    typingState.clear();
    renderTyping();

    activeChatId = chatId;
    localStorage.setItem("activeChatId", activeChatId);

    const found = chats.find(c => c.id === chatId);
    activeChatTitle = found ? computeChatTitle(found) : chatId;

    $("msgs").innerHTML = "";
    addSystem(`üìå Chat: ${activeChatTitle}`);

    renderChatList();
    loadHistory();
  }

  async function createGroupChat(title){
    const t = (title || "").trim();
    if (!t) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞.");
    const data = await api("/api/chats", "POST", { title: t });
    await refreshChats(false);
    selectChat(data.chat.id);
    addSystem(`‚úÖ Created: ${data.chat.title}`);
  }
  async function createDM(user){
    const u = (user || "").trim();
    if (!u) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ username.");
    const data = await api("/api/chats/dm", "POST", { username: u });
    await refreshChats(false);
    selectChat(data.chat.id);
    addSystem(`‚úÖ ${data.chat.title}`);
  }

  // =========================
  // Messages: render/edit/delete
  // =========================
  function addMsg(m){
    const box = $("msgs");
    const div = document.createElement("div");
    div.className = "msg" + ((m.sender === me) ? " me" : "");
    div.dataset.msgId = String(m.id || "");
    div.dataset.sender = String(m.sender || "");
    div.dataset.deletedForAll = String(!!m.deleted_for_all);

    const meta = document.createElement("div");
    meta.className = "meta";

    const left = document.createElement("b");
    left.textContent = m.sender || "‚Äî";
    const right = document.createElement("span");
    right.textContent = fmtTs(m.created_at);

    if (m.is_edited){
      const ed = document.createElement("span");
      ed.className = "edited";
      ed.textContent = "edited";
      right.appendChild(ed);
    }

    meta.appendChild(left);
    meta.appendChild(right);
    div.appendChild(meta);

    const body = document.createElement("div");
    body.dataset.role = "body";

    if (m.deleted_for_all){
      body.className = "deleted";
      body.textContent = "–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ";
      div.appendChild(body);
    } else {
      const media_url = m.media_url || "";
      const media_kind = m.media_kind || "";
      const media_name = m.media_name || "";
      const text = (m.text || "").trim();

      if (media_url && media_kind === "image"){
        const wrap = document.createElement("div");
        wrap.className = "media";
        const img = document.createElement("img");
        img.src = media_url;
        img.alt = media_name || "image";
        img.loading = "lazy";
        img.style.cursor = "pointer";
        img.onclick = () => window.open(media_url, "_blank");
        wrap.appendChild(img);
        div.appendChild(wrap);
      }

      if (media_url && media_kind === "video"){
        const wrap = document.createElement("div");
        wrap.className = "media";
        const video = document.createElement("video");
        video.src = media_url;
        video.controls = true;
        video.preload = "metadata";
        wrap.appendChild(video);
        div.appendChild(wrap);
      }

      if (media_url && media_kind === "audio"){
        const wrap = document.createElement("div");
        wrap.className = "media";
        wrap.style.padding = "10px";
        const player = createVoicePlayer(media_url);
        wrap.appendChild(player.root);
        div.appendChild(wrap);
      }

      body.textContent = text;
      body.style.marginTop = (media_url ? "8px" : "0");
      div.appendChild(body);
    }

    // context menu (–ü–ö–ú / long press)
    div.addEventListener("contextmenu", (e)=>{
      e.preventDefault();
      openCtxForMsg(div, e.clientX, e.clientY);
    });

    let lpTimer = null;
    div.addEventListener("pointerdown", (e)=>{
      if (e.pointerType === "mouse") return;
      lpTimer = setTimeout(()=> openCtxForMsg(div, e.clientX, e.clientY), 520);
    });
    div.addEventListener("pointerup", ()=> { if (lpTimer) clearTimeout(lpTimer); lpTimer = null; });
    div.addEventListener("pointercancel", ()=> { if (lpTimer) clearTimeout(lpTimer); lpTimer = null; });

    msgElById.set(m.id, div);
    lastMsgId = Math.max(lastMsgId, Number(m.id||0));

    const stick = isNearBottom(box);
    box.appendChild(div);
    if (stick) {
      scrollToBottom(box);
      maybeMarkRead();
    }
    updateToBottom();
  }

  function applyEdited(id, text, isEdited){
    const el = msgElById.get(id);
    if (!el) return;
    if (el.dataset.deletedForAll === "true") return;

    const body = el.querySelector('[data-role="body"]');
    if (body) body.textContent = text;

    const metaRight = el.querySelector(".meta span");
    if (metaRight && isEdited && !metaRight.querySelector(".edited")){
      const ed = document.createElement("span");
      ed.className = "edited";
      ed.textContent = "edited";
      metaRight.appendChild(ed);
    }
  }

  function applyDeletedAll(id){
    const el = msgElById.get(id);
    if (!el) return;
    el.dataset.deletedForAll = "true";
    el.querySelectorAll(".media").forEach(n => n.remove());
    const body = el.querySelector('[data-role="body"]');
    if (body){
      body.className = "deleted";
      body.textContent = "–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ";
    }
  }

  async function loadHistory(){
    if (!token) return openAuth("login");
    if (!activeChatId) return;

    const box = $("msgs");
    box.innerHTML = "";
    msgElById.clear();
    lastMsgId = 0;

    addSystem(`üì• Loading: ${activeChatTitle}‚Ä¶`);

    try{
      const data = await api(`/api/messages?chat_id=${encodeURIComponent(activeChatId)}`);
      box.innerHTML = "";
      for (const m of (data.messages || [])) addMsg(m);
      scrollToBottom(box);
      updateToBottom();
      maybeMarkRead();
      refreshChats(false).catch(()=>{});
    } catch (e) {
      addSystem("‚ùå " + e.message);
    }
  }

  async function send(){
    const text = $("text").value.trim();
    if (!text) return;
    if (!token) return openAuth("login");
    if (!activeChatId) return;

    $("text").value = "";
    try{
      // –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ WS
      await api("/api/messages", "POST", { chat_id: activeChatId, text });
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  }

  // =========================
  // Read marker (unread)
  // =========================
  let lastMarked = 0;
  async function maybeMarkRead(){
    if (!token || !activeChatId) return;
    if (!lastMsgId) return;
    if (!isNearBottom($("msgs"))) return;
    if (lastMsgId <= lastMarked) return;

    lastMarked = lastMsgId;
    try{
      await api(`/api/chats/${encodeURIComponent(activeChatId)}/read?last_id=${lastMsgId}`, "POST");
      refreshChats(false).catch(()=>{});
    }catch(_){}
  }

  // =========================
  // Context menu
  // =========================
  const ctx = {
    el: $("ctxMenu"),
    edit: $("ctxEdit"),
    delMe: $("ctxDeleteMe"),
    delAll: $("ctxDeleteAll"),
    cancel: $("ctxCancel"),
    msgEl: null,
    msgId: 0,
    sender: ""
  };

  function closeCtx(){
    ctx.el.classList.remove("open");
    ctx.msgEl = null;
    ctx.msgId = 0;
    ctx.sender = "";
  }

  function openCtxForMsg(msgEl, x, y){
    const msgId = Number(msgEl.dataset.msgId || "0");
    const sender = msgEl.dataset.sender || "";
    const deleted = (msgEl.dataset.deletedForAll === "true");
    if (!msgId) return;

    ctx.msgEl = msgEl;
    ctx.msgId = msgId;
    ctx.sender = sender;

    ctx.edit.style.display = (!deleted && sender === me) ? "" : "none";
    ctx.delAll.style.display = (!deleted && sender === me) ? "" : "none";
    ctx.delMe.style.display = "";

    ctx.el.style.left = `${Math.min(x, window.innerWidth - 220)}px`;
    ctx.el.style.top = `${Math.min(y, window.innerHeight - 160)}px`;
    ctx.el.classList.add("open");
  }

  async function startInlineEdit(msgEl){
    closeCtx();
    const msgId = Number(msgEl.dataset.msgId || "0");
    if (!msgId) return;

    const body = msgEl.querySelector('[data-role="body"]');
    if (!body) return;

    const old = body.textContent || "";
    const input = document.createElement("input");
    input.value = old;
    input.style.marginTop = "6px";

    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.gap = "8px";
    row.style.marginTop = "8px";

    const save = document.createElement("button");
    save.className = "btn";
    save.textContent = "Save";
    save.style.flex = "1";

    const cancel = document.createElement("button");
    cancel.className = "btn danger";
    cancel.textContent = "Cancel";
    cancel.style.flex = "1";

    const original = old;
    body.textContent = "";
    body.appendChild(input);
    body.appendChild(row);
    row.appendChild(save);
    row.appendChild(cancel);

    const cleanup = () => { body.innerHTML = ""; body.textContent = original; };

    cancel.onclick = () => cleanup();
    save.onclick = async () => {
      const newText = input.value.trim();
      if (newText.length > 2000) return addSystem("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ (–º–∞–∫—Å 2000).");
      try{
        await api(`/api/messages/${msgId}`, "PATCH", { text: newText });
        applyEdited(msgId, newText, true);
        body.innerHTML = "";
        body.textContent = newText;
      }catch(e){
        addSystem("‚ùå " + (e.message || e));
        cleanup();
      }
    };

    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") save.click();
      if (e.key === "Escape") cancel.click();
    });
    setTimeout(()=> input.focus(), 10);
  }

  async function deleteForMe(msgId){
    try{
      await api(`/api/messages/${msgId}?scope=me`, "DELETE");
      const el = msgElById.get(msgId);
      if (el) el.remove();
      msgElById.delete(msgId);
      refreshChats(false).catch(()=>{});
    }catch(e){
      addSystem("‚ùå " + (e.message || e));
    }
  }

  async function deleteForAll(msgId){
    try{
      await api(`/api/messages/${msgId}?scope=all`, "DELETE");
      applyDeletedAll(msgId);
      refreshChats(false).catch(()=>{});
    }catch(e){
      addSystem("‚ùå " + (e.message || e));
    }
  }

  ctx.edit.onclick = () => { if (ctx.msgEl) startInlineEdit(ctx.msgEl); };
  ctx.delMe.onclick = () => { const id = ctx.msgId; closeCtx(); if (id) deleteForMe(id); };
  ctx.delAll.onclick = () => { const id = ctx.msgId; closeCtx(); if (id) deleteForAll(id); };
  ctx.cancel.onclick = () => closeCtx();
  document.addEventListener("click", (e)=>{ if (!ctx.el.contains(e.target)) closeCtx(); });

  // =========================
  // Session UI
  // =========================
  function setWhoami(){
    $("whoText").textContent = token ? `@${me}` : "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    $("btnOpenAuth").style.display = token ? "none" : "";
    $("btnLogout").style.display = token ? "" : "none";
    $("btnProfile").style.display = token ? "" : "none";

    const img = $("topAvatar");
    if (token && avatarUrl){
      img.src = avatarUrl;
      img.classList.add("show");
    } else {
      img.classList.remove("show");
      img.removeAttribute("src");
    }
  }

  function logout(){
    stopAllExcept(null);
    token = ""; me = ""; avatarUrl = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    localStorage.removeItem("avatar_url");
    localStorage.removeItem("activeChatId");

    if (ws) { try{ ws.close(); }catch{} ws = null; }

    $("msgs").innerHTML = "";
    chats = [];
    activeChatId = "";
    activeChatTitle = "";
    renderChatList();
    setWhoami();
    setStatus("üëã Logged out");
    setNet("offline");
    closeSidebar();
    closeSheet();
    closeProfile();
    closeVoicePreview();
    openAuth("login");
  }

  // =========================
  // Wiring
  // =========================
  $("btnToggleSidebar").onclick = () => toggleSidebar();
  $("drawerBackdrop").onclick = () => closeSidebar();
  window.addEventListener("resize", ()=> { if (!isMobile()) closeSidebar(); });

  $("btnOpenAuth").onclick = () => openAuth("login");
  $("btnLogout").onclick = () => logout();
  $("btnProfile").onclick = () => openProfile();

  $("tabLogin").onclick = () => setAuthTab("login");
  $("tabRegister").onclick = () => setAuthTab("register");
  $("btnCloseAuth").onclick = () => { if (!token) return; closeAuth(); };
  $("btnAuthSubmit").onclick = () => authSubmit();
  $("authPassword").addEventListener("keydown", (e)=>{ if (e.key === "Enter") authSubmit(); });

  $("btnOpenCreateGroup").onclick = () => openSheet("group");
  $("btnOpenCreateDM").onclick = () => openSheet("dm");
  $("btnCloseSheet").onclick = () => closeSheet();
  $("btnSheetCancel").onclick = () => closeSheet();
  $("sheetOverlay").addEventListener("click", (e)=>{ if (e.target === $("sheetOverlay")) closeSheet(); });
  $("btnSheetOk").onclick = async () => {
    try{
      const value = sheet.input.value;
      const mode = sheet.mode;
      closeSheet();
      if (mode === "group") await createGroupChat(value);
      if (mode === "dm") await createDM(value);
      if (isMobile()) closeSidebar();
    }catch(e){
      addSystem("‚ùå " + (e.message || e));
    }
  };
  $("sheetInput").addEventListener("keydown", (e)=>{ if (e.key === "Enter") $("btnSheetOk").click(); });

  $("btnCloseProfile").onclick = () => closeProfile();
  $("profileOverlay").addEventListener("click", (e)=>{ if (e.target === $("profileOverlay")) closeProfile(); });
  $("btnUploadAvatar").onclick = () => uploadAvatar();

  $("btnCloseVoicePreview").onclick = () => { closeVoicePreview(); clearPreview(); };
  $("btnCancelVoiceNow").onclick = () => { closeVoicePreview(); clearPreview(); };
  $("btnSendVoiceNow").onclick = () => sendVoiceNow();

  $("btnAttach").onclick = () => $("file").click();
  $("file").addEventListener("change", async () => {
    const f = $("file").files && $("file").files[0];
    if (!f) return;
    try{ await uploadMedia(f); }
    catch(e){ addSystem("‚ùå " + (e.message || e)); }
  });

  $("btnSend").onclick = () => send();
  $("text").addEventListener("keydown", (e)=>{ if (e.key === "Enter") send(); });
  $("text").addEventListener("input", ()=> onLocalTyping());

  recBtn.addEventListener("pointerdown", async (e)=>{ e.preventDefault(); if (!rec.active) await startHoldRec(); });
  recBtn.addEventListener("pointerup", (e)=>{ e.preventDefault(); stopHoldRec(); });
  recBtn.addEventListener("pointercancel", (e)=>{ e.preventDefault(); stopHoldRec(); });
  recBtn.addEventListener("pointerleave", (e)=>{ if (rec.active) stopHoldRec(); });

  $("btnRefreshChats").onclick = () => refreshChats(false).catch(e=> addSystem("‚ùå " + e.message));
  $("btnLoadHistory").onclick = () => loadHistory().catch(e=> addSystem("‚ùå " + e.message));

  $("msgs").addEventListener("scroll", ()=> updateToBottom(), { passive:true });
  toBottomBtn.onclick = () => { scrollToBottom($("msgs")); updateToBottom(); };

  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape"){
      closeCtx();
      closeSidebar();
      closeSheet();
      closeProfile();
    }
  });

  // =========================
  // Bootstrap
  // =========================
  setWhoami();

  if (token){
    addSystem("üîÅ Checking session‚Ä¶");
    api("/api/me")
      .then(async data => {
        me = data.username;
        avatarUrl = data.avatar_url || "";
        localStorage.setItem("username", me);
        localStorage.setItem("avatar_url", avatarUrl || "");
        setWhoami();

        connectWS_GLOBAL();       // <‚Äî now global WS once
        await refreshChats(true);
      })
      .catch(() => {
        token = "";
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("avatar_url");
        localStorage.removeItem("activeChatId");
        me = "";
        avatarUrl = "";
        setWhoami();
        addSystem("üîê –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏ —Å–Ω–æ–≤–∞.");
        openAuth("login");
      });
  } else {
    addSystem("üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.");
    openAuth("login");
  }
</script>
</body>
</html>
