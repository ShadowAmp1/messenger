<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mini Messenger</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background: #0b1220; color: #e6eefc; }
    .wrap { display: grid; place-items: center; min-height: 100vh; padding: 16px; }
    .card { width: min(920px, 100%); background: #121a2b; border: 1px solid #24304a; border-radius: 14px; overflow: hidden; }
    .top { display:flex; gap: 10px; padding: 14px; border-bottom: 1px solid #24304a; align-items: center; }
    .top input { flex:1; padding: 10px; border-radius: 10px; border: 1px solid #24304a; background:#0b1220; color:#e6eefc; }
    .top button { padding: 10px 14px; border-radius: 10px; border: 1px solid #24304a; background:#1b2742; color:#e6eefc; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 280px 1fr; height: 70vh; }
    .sidebar { border-right: 1px solid #24304a; padding: 14px; }
    .chat { display:flex; flex-direction: column; }
    .msgs { flex:1; overflow:auto; padding: 14px; display:flex; flex-direction: column; gap: 10px; }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; border: 1px solid #24304a; background:#0b1220; }
    .me { align-self: flex-end; background:#12284a; }
    .meta { font-size: 12px; opacity: .8; margin-bottom: 4px; }
    .composer { display:flex; gap: 10px; padding: 14px; border-top: 1px solid #24304a; }
    .composer input { flex:1; padding: 12px; border-radius: 12px; border: 1px solid #24304a; background:#0b1220; color:#e6eefc; }
    .composer button { padding: 12px 16px; border-radius: 12px; border: 1px solid #24304a; background:#1b2742; color:#e6eefc; cursor:pointer; }
    .hint { font-size: 13px; opacity: .9; }
    .row { display:flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .small { font-size: 12px; opacity: .8; margin-top: 8px; word-break: break-word; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <input id="username" placeholder="username (3-20, a-z 0-9 _)" />
        <input id="password" placeholder="password (min 6)" type="password" />
        <button id="btnRegister" type="button">Register</button>
        <button id="btnLogin" type="button">Login</button>
      </div>

      <div class="grid">
        <div class="sidebar">
          <div><b>Chats</b></div>
          <div class="hint">ÐŸÐ¾ÐºÐ° Ð¾Ð´Ð¸Ð½ Ñ‡Ð°Ñ‚: <b>general</b></div>
          <div class="row">
            <button id="btnHealth" type="button">Health</button>
            <button id="btnLoad" type="button">Load history</button>
            <button id="btnLogout" type="button">Logout</button>
          </div>
          <div class="small" id="status"></div>
        </div>

        <div class="chat">
          <div class="msgs" id="msgs"></div>
          <div class="composer">
            <input id="text" placeholder="ÐÐ°Ð¿Ð¸ÑˆÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." />
            <button id="btnSend" type="button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let ws = null;

  function setStatus(s){ $("status").textContent = s; }

  function addSystem(text) {
    const div = document.createElement("div");
    div.className = "msg";
    div.style.opacity = ".85";
    div.textContent = text;
    $("msgs").appendChild(div);
    $("msgs").scrollTop = $("msgs").scrollHeight;
  }

  function addMsg({sender, text, created_at}) {
    const div = document.createElement("div");
    div.className = "msg" + (sender === me ? " me" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    const t = new Date(created_at * 1000).toLocaleTimeString();
    meta.textContent = `${sender} â€¢ ${t}`;
    const body = document.createElement("div");
    body.textContent = text;
    div.appendChild(meta);
    div.appendChild(body);
    $("msgs").appendChild(div);
    $("msgs").scrollTop = $("msgs").scrollHeight;
  }

  // Robust API helper: shows real server response (even HTML)
  async function api(path, method="GET", body=null) {
    const opts = { method, headers: {} };
    if (body) {
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }

    const res = await fetch(path, opts);
    const raw = await res.text();

    let data = {};
    try { data = JSON.parse(raw); }
    catch { data = { detail: raw }; }

    if (!res.ok) {
      throw new Error(`${res.status} ${res.statusText}: ${data.detail || raw}`);
    }
    return data;
  }

  async function health() {
    const data = await api("/api/health");
    addSystem("âœ… Health OK: " + JSON.stringify(data));
  }

  async function registerUser() {
    const username = $("username").value.trim();
    const password = $("password").value;

    await api("/api/register", "POST", {username, password});
    addSystem("âœ… Registered. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð½Ð°Ð¶Ð¼Ð¸ Login.");
  }

  async function loginUser() {
    const username = $("username").value.trim();
    const password = $("password").value;

    const data = await api("/api/login", "POST", {username, password});
    token = data.token;
    me = data.username;
    localStorage.setItem("token", token);
    localStorage.setItem("username", me);
    addSystem(`âœ… Logged in as ${me}`);
    connectWS();
    await loadHistory();
  }

  async function loadHistory() {
    if (!token) return addSystem("âš ï¸ Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð»Ð¾Ð³Ð¸Ð½.");
    $("msgs").innerHTML = "";
    const data = await api(`/api/messages?token=${encodeURIComponent(token)}`);
    for (const m of data.messages) addMsg(m);
  }

  function connectWS() {
    if (!token) return;
    if (ws) ws.close();

    const proto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${proto}://${location.host}/ws?token=${encodeURIComponent(token)}`);

    ws.onopen = () => setStatus("ðŸŸ¢ Connected");
    ws.onclose = () => setStatus("ðŸ”´ Disconnected");
    ws.onerror = () => setStatus("âš ï¸ WS error");

    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      if (data.type === "message") addMsg(data);
      if (data.type === "presence") addSystem(`ðŸ‘¤ ${data.user} is ${data.status}`);
    };
  }

  function send() {
    const text = $("text").value.trim();
    if (!text) return;
    if (!ws || ws.readyState !== 1) return addSystem("âš ï¸ ÐÐµÑ‚ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ WS");
    ws.send(JSON.stringify({type:"message", text}));
    $("text").value = "";
  }

  function logout() {
    token = ""; me = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    if (ws) ws.close();
    ws = null;
    setStatus("");
    $("msgs").innerHTML = "";
    addSystem("ðŸ‘‹ Logged out");
  }

  $("btnRegister").addEventListener("click", (e) => {
    e.preventDefault();
    registerUser().catch(err => addSystem("âŒ " + err.message));
  });

  $("btnLogin").addEventListener("click", (e) => {
    e.preventDefault();
    loginUser().catch(err => addSystem("âŒ " + err.message));
  });

  $("btnHealth").addEventListener("click", (e) => {
    e.preventDefault();
    health().catch(err => addSystem("âŒ " + err.message));
  });

  $("btnLoad").addEventListener("click", (e) => {
    e.preventDefault();
    loadHistory().catch(err => addSystem("âŒ " + err.message));
  });

  $("btnSend").addEventListener("click", (e) => {
    e.preventDefault();
    send();
  });

  $("btnLogout").addEventListener("click", (e) => {
    e.preventDefault();
    logout();
  });

  $("text").addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

  // Auto restore
  if (token) {
    addSystem(`ðŸ” Restoring session for ${me || "user"}...`);
    connectWS();
    loadHistory().catch(()=>{});
  }
</script>
</body>
</html>
