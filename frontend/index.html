<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Messenger</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --border:#24304a;
      --muted:rgba(230,238,252,.85);
      --btn:#1b2742;
      --btn2:#12284a;
      --shadow: 0 18px 50px rgba(0,0,0,.5);
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: system-ui, Arial;
      background: var(--bg);
      color:#e6eefc;
      overflow: hidden; /* –ö–õ–Æ–ß: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ —Å–∫—Ä–æ–ª–ª–∏—Ç—Å—è */
    }

    /* ===== Layout shell ===== */
    .wrap{
      height: 100dvh; /* iOS Safari fix */
      padding: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ iOS */
    @supports (-webkit-touch-callout: none) {
      html{ height: -webkit-fill-available; }
      .wrap{ height: -webkit-fill-available; }
    }

    .card{
      width: min(1100px, 100%);
      height: calc(100dvh - 32px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 0;
    }

    /* ===== Top bar (safe-area aware) ===== */
    .top{
      flex: 0 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      padding: calc(10px + env(safe-area-inset-top)) 12px 10px 12px; /* –ö–õ–Æ–ß: –Ω–∏–∂–µ –Ω–∞ iPhone */
      border-bottom: 1px solid var(--border);
      background: rgba(18,26,43,.92);
      backdrop-filter: blur(6px);
      z-index: 50;
    }

    .top-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }

    .brand{ font-weight:700; white-space:nowrap; }
    .pill{
      font-size:12px;
      opacity:.95;
      padding: 4px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#0b1220;
      white-space:nowrap;
      max-width: 42vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .small{ font-size:12px; opacity:.85; color: var(--muted); }

    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .btn{
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform: translateY(1px); }

    /* ===== Main grid ===== */
    .grid{
      flex: 1 1 auto;
      min-height: 0;
      display:grid;
      grid-template-columns: 330px 1fr;
      height: auto; /* –ö–õ–Æ–ß: –Ω–µ —Å—á–∏—Ç–∞–µ–º –≤—ã—Å–æ—Ç—É –≤—Ä—É—á–Ω—É—é */
    }

    /* ===== Sidebar ===== */
    .sidebar{
      min-height: 0;
      border-right: 1px solid var(--border);
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden; /* —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ chatlist */
      background: var(--card);
    }

    .sep{ height: 1px; background: var(--border); opacity:.8; margin: 6px 0; }

    .chatlist{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      overscroll-behavior: contain;
      display:flex;
      flex-direction: column;
      gap: 6px;
      padding-right: 4px;
    }

    .chatitem{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:8px;
      padding: 12px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:#0b1220;
      cursor:pointer;
      min-width: 0;
      touch-action: manipulation;
    }
    .chatitem:hover{ filter:brightness(1.08); }
    .chatitem.active{ background: var(--btn2); }

    .title{ font-weight:650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sub{ font-size:11px; opacity:.75; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badge{ font-size:11px; opacity:.9; padding:2px 8px; border:1px solid var(--border); border-radius:999px; }

    .iconbar{ display:flex; gap:8px; }
    .iconbtn{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .iconbtn:hover{ filter:brightness(1.12); }
    .iconbtn:active{ transform: translateY(1px); }

    /* Desktop popovers only */
    .pop-wrap{ position: relative; }
    .popover{
      position:absolute;
      top: 48px;
      right: 0;
      width: 320px;
      max-width: min(320px, 86vw);
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      display:none;
      z-index: 20;
    }
    .popover.open{ display:block; }
    .popover .head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .popover .head b{ font-size: 13px; }
    .popover input{
      width:100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px;
    }
    .popover .actions{ display:flex; gap:8px; margin-top:10px; }
    .popover button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      flex:1;
      touch-action: manipulation;
    }
    .xbtn{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      cursor:pointer;
    }

    /* ===== Chat ===== */
    .chat{
      min-height: 0;
      display:flex;
      flex-direction: column;
      overflow:hidden;
      position: relative;
    }

    .msgs{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      overscroll-behavior: contain;
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg{
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background:#0b1220;
      word-break: break-word;
    }
    .me{ align-self: flex-end; background: var(--btn2); }
    .meta{ font-size: 12px; opacity:.8; margin-bottom: 4px; }

    .composer{
      flex: 0 0 auto;
      display:flex;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: rgba(11,18,32,.75);
      backdrop-filter: blur(6px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .composer input{
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px; /* iOS: –Ω–µ –∑—É–º–∏—Ç */
    }
    .composer button{
      min-width: 86px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      touch-action: manipulation;
    }

    /* Arrow down */
    .to-bottom{
      position:absolute;
      right: 12px;
      bottom: calc(12px + 60px + env(safe-area-inset-bottom));
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(11,18,32,.92);
      color:#e6eefc;
      display:none;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      user-select:none;
      touch-action: manipulation;
      z-index: 30;
    }
    .to-bottom.show{ display:grid; }

    /* ===== Auth modal ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 999;
      padding: 18px;
    }
    .modal-overlay.open{ display:grid; place-items:center; }

    .modal{
      width: min(520px, 100%);
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .modal-top{
      padding: 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .tabs{ display:flex; gap:8px; }
    .tab{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#0b1220;
      cursor:pointer;
      font-size: 13px;
      opacity:.95;
      user-select:none;
      touch-action: manipulation;
    }
    .tab.active{ background: var(--btn2); }
    .modal-body{ padding: 14px; display:flex; flex-direction: column; gap: 10px; }
    .modal-body input{
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px;
    }
    .modal-body .btnrow{ display:flex; gap:10px; margin-top: 6px; }
    .modal-body button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      flex:1;
      touch-action: manipulation;
    }
    .err{ font-size: 12px; color:#ffd3d3; opacity:.95; display:none; }
    .modal-hint{ font-size: 12px; opacity:.85; color: var(--muted); }

    /* ===== Mobile: drawer + sheet ===== */
    .mobile-only{ display:none; }

    .drawer-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 120;
    }
    .drawer-backdrop.open{ display:block; }

    /* Bottom sheet (mobile create) */
    .sheet-overlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 400;
      padding: 12px;
    }
    .sheet-overlay.open{ display:flex; align-items:flex-end; justify-content:center; }
    .sheet{
      width: min(520px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .sheet-top{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
    }
    .sheet-body{
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .sheet-body input{
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px;
    }
    .sheet-actions{ display:flex; gap:10px; margin-top: 6px; }
    .sheet-actions button{
      flex:1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      touch-action: manipulation;
    }

    @media (max-width: 900px){
      .wrap{ padding: 0; height: 100dvh; }
      .card{
        width: 100%;
        height: 100dvh;
        border-radius: 0;
        border-left: 0;
        border-right: 0;
      }
      .grid{ grid-template-columns: 1fr; }

      .mobile-only{ display:inline-flex; }
      .brand{ display:none; }

      .sidebar{
        position: fixed;
        top: 0; /* –º—ã —É—á–∏—Ç—ã–≤–∞–µ–º safe-area –≤ .top, –ø–æ—ç—Ç–æ–º—É sidebar —Å 0 */
        left: 0;
        width: min(360px, 92vw);
        height: 100dvh;
        transform: translateX(-110%);
        transition: transform .2s ease;
        z-index: 130;
        box-shadow: 0 18px 50px rgba(0,0,0,.45);
        /* –í–∞–∂–Ω–æ: –≤–Ω—É—Ç—Ä–∏ sidebar –µ—Å—Ç—å .topbar? –Ω–µ—Ç. –ø–æ—ç—Ç–æ–º—É –¥–∞—ë–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
        padding-top: calc(58px + env(safe-area-inset-top)); /* —á—Ç–æ–±—ã –Ω–µ –∑–∞–ª–µ–∑–ª–æ –ø–æ–¥ top */
      }
      .sidebar.open{ transform: translateX(0); }

      /* –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ popover –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é */
      .popover{ display:none !important; }

      .msgs{ padding: 12px; }
      .msg{ max-width: 92%; }
    }
  </style>
</head>

<body>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="top-left">
          <button class="btn mobile-only" id="btnToggleSidebar" type="button">‚ò∞ Chats</button>
          <div class="brand">Mini Messenger</div>
          <div class="pill" id="whoami">not logged in</div>
          <div class="small" id="status"></div>
        </div>
        <div class="row">
          <button class="btn" id="btnOpenAuth" type="button">Login / Register</button>
          <button class="btn" id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>

      <div class="grid">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
          <div class="row" style="justify-content: space-between;">
            <div><b>Chats</b></div>
            <div class="iconbar">
              <div class="pop-wrap">
                <div class="iconbtn" id="btnOpenCreateGroup" title="New group chat">‚ûï</div>
                <!-- Desktop popover only -->
                <div class="popover" id="popGroup">
                  <div class="head">
                    <b>–ù–æ–≤—ã–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</b>
                    <button class="xbtn" id="btnCloseGroup" type="button">‚úï</button>
                  </div>
                  <input id="groupTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: work)" />
                  <div class="actions">
                    <button id="btnCreateGroup" type="button">Create</button>
                  </div>
                  <div class="small" style="margin-top:8px;">–°–æ–∑–¥–∞—Å—Ç —á–∞—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç —Ç–µ–±—è –≤ –Ω–µ–≥–æ.</div>
                </div>
              </div>

              <div class="pop-wrap">
                <div class="iconbtn" id="btnOpenCreateDM" title="New DM">üí¨</div>
                <!-- Desktop popover only -->
                <div class="popover" id="popDM">
                  <div class="head">
                    <b>–ù–æ–≤—ã–π DM</b>
                    <button class="xbtn" id="btnCloseDM" type="button">‚úï</button>
                  </div>
                  <input id="dmUser" placeholder="Username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
                  <div class="actions">
                    <button id="btnCreateDM" type="button">Open DM</button>
                  </div>
                  <div class="small" style="margin-top:8px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.</div>
                </div>
              </div>

              <div class="iconbtn" id="btnRefreshChats" title="Refresh chats">‚ü≥</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn" id="btnLoadHistory" type="button">Load history</button>
          </div>

          <div class="sep"></div>

          <div class="chatlist" id="chatlist"></div>

          <div class="small" style="margin-top:auto;">
            –°–æ–≤–µ—Ç—ã: ‚ûï —Å–æ–∑–¥–∞—ë—Ç –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç, üí¨ —Å–æ–∑–¥–∞—ë—Ç DM, ‚ü≥ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫.
          </div>
        </div>

        <!-- Chat -->
        <div class="chat">
          <div class="msgs" id="msgs"></div>
          <div class="to-bottom" id="btnToBottom" title="–í–Ω–∏–∑">‚¨áÔ∏è</div>

          <div class="composer">
            <input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button id="btnSend" type="button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal-overlay" id="authOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <div class="tabs">
          <div class="tab active" id="tabLogin">Login</div>
          <div class="tab" id="tabRegister">Register</div>
        </div>
        <button class="xbtn" id="btnCloseAuth" type="button" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <input id="authUsername" placeholder="username (3-20: a-z 0-9 _)" autocomplete="username" />
        <input id="authPassword" placeholder="password (–º–∏–Ω 6)" type="password" autocomplete="current-password" />
        <div class="err" id="authError"></div>
        <div class="btnrow">
          <button id="btnAuthSubmit" type="button">Login</button>
        </div>
        <div class="modal-hint">
          –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>
      </div>
    </div>
  </div>

  <!-- MOBILE SHEET (create) -->
  <div class="sheet-overlay" id="sheetOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-top">
        <b id="sheetTitle">–°–æ–∑–¥–∞—Ç—å</b>
        <button class="xbtn" id="btnCloseSheet" type="button">‚úï</button>
      </div>
      <div class="sheet-body">
        <input id="sheetInput" placeholder="" />
        <div class="sheet-actions">
          <button id="btnSheetAction" type="button">OK</button>
        </div>
        <div class="small" id="sheetHint" style="opacity:.85;"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let ws = null;

  let chats = [];
  let activeChatId = localStorage.getItem("activeChatId") || "general";
  let activeChatTitle = "general";

  function isMobile(){
    return window.matchMedia("(max-width: 900px)").matches;
  }

  /* ===== Drawer ===== */
  const sidebar = $("sidebar");
  const backdrop = $("drawerBackdrop");
  function openSidebar(){ sidebar.classList.add("open"); backdrop.classList.add("open"); }
  function closeSidebar(){ sidebar.classList.remove("open"); backdrop.classList.remove("open"); }
  function toggleSidebar(){ sidebar.classList.contains("open") ? closeSidebar() : openSidebar(); }

  /* ===== Scroll + arrow ===== */
  const toBottomBtn = $("btnToBottom");
  function isNearBottom(el, px=160){
    return (el.scrollHeight - el.scrollTop - el.clientHeight) < px;
  }
  function scrollToBottom(el){
    el.scrollTop = el.scrollHeight;
  }
  function updateToBottom(){
    const box = $("msgs");
    toBottomBtn.classList.toggle("show", !isNearBottom(box));
  }

  /* ===== UI helpers ===== */
  function setStatus(s){ $("status").textContent = s; }
  function setWhoami(){
    $("whoami").textContent = me ? `üë§ ${me}` : "not logged in";
    $("btnLogout").style.display = me ? "" : "none";
    $("btnOpenAuth").style.display = me ? "none" : "";
  }

  function addSystem(text){
    const box = $("msgs");
    const stick = isNearBottom(box);
    const div = document.createElement("div");
    div.className = "msg";
    div.style.opacity = ".85";
    div.textContent = text;
    box.appendChild(div);
    if (stick) scrollToBottom(box);
    updateToBottom();
  }

  function addMsg({sender, text, created_at}){
    const box = $("msgs");
    const stick = isNearBottom(box);

    const div = document.createElement("div");
    div.className = "msg" + (sender === me ? " me" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${sender} ‚Ä¢ ${new Date(created_at * 1000).toLocaleTimeString()}`;
    const body = document.createElement("div");
    body.textContent = text;

    div.appendChild(meta);
    div.appendChild(body);
    box.appendChild(div);

    if (stick) scrollToBottom(box);
    updateToBottom();
  }

  async function api(path, method="GET", body=null){
    const opts = { method, headers: {} };
    if (token) opts.headers["Authorization"] = `Bearer ${token}`;
    if (body){
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(path, opts);
    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { data = { detail: raw }; }
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${data.detail || raw}`);
    return data;
  }

  /* ===== AUTH ===== */
  let authMode = "login";
  function openAuth(mode="login"){
    authMode = mode;
    $("authOverlay").classList.add("open");
    $("authOverlay").setAttribute("aria-hidden","false");
    $("authError").style.display = "none";
    $("authError").textContent = "";
    setAuthTab(mode);
    $("authUsername").value = me || $("authUsername").value || "";
    $("authPassword").value = "";
    setTimeout(()=> $("authUsername").focus(), 50);
  }
  function closeAuth(){
    $("authOverlay").classList.remove("open");
    $("authOverlay").setAttribute("aria-hidden","true");
  }
  function setAuthTab(mode){
    authMode = mode;
    $("tabLogin").classList.toggle("active", mode==="login");
    $("tabRegister").classList.toggle("active", mode==="register");
    $("btnAuthSubmit").textContent = (mode==="login") ? "Login" : "Register";
    $("authPassword").setAttribute("autocomplete", mode==="login" ? "current-password" : "new-password");
  }
  function authError(msg){
    $("authError").style.display = "";
    $("authError").textContent = msg;
  }
  async function authSubmit(){
    const username = $("authUsername").value.trim();
    const password = $("authPassword").value;
    $("authError").style.display="none";
    $("authError").textContent="";

    try{
      if (authMode === "register"){
        await api("/api/register", "POST", {username, password});
      }
      const data = await api("/api/login", "POST", {username, password});
      token = data.token;
      me = data.username;
      localStorage.setItem("token", token);
      localStorage.setItem("username", me);

      setWhoami();
      closeAuth();
      addSystem(`‚úÖ Logged in as ${me}`);

      await refreshChats();
      if (!chats.find(c => c.id === activeChatId)) activeChatId = "general";
      selectChat(activeChatId);
    }catch(e){
      authError(e.message);
    }
  }

  /* ===== Desktop popover ===== */
  function closePopovers(){
    $("popGroup").classList.remove("open");
    $("popDM").classList.remove("open");
  }
  function toggleDesktopPopover(id){
    const el = $(id);
    const isOpen = el.classList.contains("open");
    closePopovers();
    if (!isOpen) el.classList.add("open");
  }

  document.addEventListener("click", (e) => {
    const groupWrap = $("btnOpenCreateGroup").parentElement;
    const dmWrap = $("btnOpenCreateDM").parentElement;
    if (!groupWrap.contains(e.target) && !dmWrap.contains(e.target)) closePopovers();
  });

  /* ===== Mobile sheet ===== */
  const sheet = {
    overlay: $("sheetOverlay"),
    title: $("sheetTitle"),
    input: $("sheetInput"),
    hint: $("sheetHint"),
    ok: $("btnSheetAction"),
    mode: null
  };

  function openSheet(mode){
    sheet.mode = mode;
    sheet.overlay.classList.add("open");
    sheet.overlay.setAttribute("aria-hidden","false");

    if (mode === "group"){
      sheet.title.textContent = "–ù–æ–≤—ã–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç";
      sheet.input.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: work)";
      sheet.hint.textContent = "–°–æ–∑–¥–∞—Å—Ç —á–∞—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç —Ç–µ–±—è –≤ –Ω–µ–≥–æ.";
      sheet.ok.textContent = "Create";
      sheet.input.value = "";
    } else {
      sheet.title.textContent = "–ù–æ–≤—ã–π DM";
      sheet.input.placeholder = "Username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
      sheet.hint.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.";
      sheet.ok.textContent = "Open DM";
      sheet.input.value = "";
    }
    setTimeout(()=> sheet.input.focus(), 50);
  }

  function closeSheet(){
    sheet.overlay.classList.remove("open");
    sheet.overlay.setAttribute("aria-hidden","true");
    sheet.mode = null;
  }

  /* ===== Chats ===== */
  function renderChatList(){
    const list = $("chatlist");
    list.innerHTML = "";

    const ordered = [...chats].sort((a,b) => (a.id === "general" ? -1 : 0) + (b.id === "general" ? 1 : 0));

    for (const c of ordered){
      const item = document.createElement("div");
      item.className = "chatitem" + (c.id === activeChatId ? " active" : "");

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";
      left.style.minWidth = "0";

      let title = c.title;
      let typeLabel = c.type;

      if (c.type === "dm" && c.title.startsWith("dm:")){
        const parts = c.title.slice(3).split("|");
        const other = parts[0] === me ? parts[1] : parts[0];
        title = `DM: ${other}`;
      }

      const t1 = document.createElement("div");
      t1.className = "title";
      t1.textContent = title;

      const t2 = document.createElement("div");
      t2.className = "sub";
      t2.textContent = c.id;

      left.appendChild(t1);
      left.appendChild(t2);

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = typeLabel;

      item.appendChild(left);
      item.appendChild(badge);

      item.onclick = () => {
        selectChat(c.id);
        if (isMobile()) closeSidebar();
      };

      list.appendChild(item);
    }
  }

  async function refreshChats(){
    if (!token){ openAuth("login"); return; }
    const data = await api("/api/chats");
    chats = data.chats || [];
    if (!chats.find(c => c.id === "general")) chats.push({id:"general", type:"group", title:"general", created_at:0});
    renderChatList();
  }

  async function createGroupChat(title){
    const t = (title || "").trim();
    if (!t) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞.");
    const data = await api("/api/chats", "POST", {title: t});
    addSystem(`‚úÖ Created: ${data.chat.title}`);
    await refreshChats();
    selectChat(data.chat.id);
  }

  async function createDM(user){
    const u = (user || "").trim();
    if (!u) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ username.");
    const data = await api("/api/chats/dm", "POST", {username: u});
    addSystem(`‚úÖ ${data.chat.title}`);
    await refreshChats();
    selectChat(data.chat.id);
  }

  function selectChat(chatId){
    activeChatId = chatId;
    localStorage.setItem("activeChatId", activeChatId);

    const found = chats.find(c => c.id === chatId);
    if (found){
      activeChatTitle = found.title;
      if (found.type === "dm" && found.title.startsWith("dm:")){
        const parts = found.title.slice(3).split("|");
        const other = parts[0] === me ? parts[1] : parts[0];
        activeChatTitle = `DM: ${other}`;
      }
    } else activeChatTitle = chatId;

    $("msgs").innerHTML = "";
    addSystem(`üìå Chat: ${activeChatTitle}`);

    renderChatList();
    connectWS();
    loadHistory().catch(err => addSystem("‚ùå " + err.message));
  }

  /* ===== Messages ===== */
  async function loadHistory(){
    if (!token) return openAuth("login");
    const box = $("msgs");
    box.innerHTML = "";
    addSystem(`üì• Loading: ${activeChatTitle}...`);
    const data = await api(`/api/messages?chat_id=${encodeURIComponent(activeChatId)}`);
    box.innerHTML = "";
    for (const m of data.messages) addMsg(m);
    scrollToBottom(box);
    updateToBottom();
  }

  function connectWS(){
    if (!token) return openAuth("login");
    if (ws) ws.close();
    const proto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${proto}://${location.host}/ws?token=${encodeURIComponent(token)}&chat_id=${encodeURIComponent(activeChatId)}`);

    ws.onopen = () => setStatus(`üü¢ WS ‚Ä¢ ${activeChatTitle}`);
    ws.onclose = () => setStatus("üî¥ WS disconnected");
    ws.onerror = () => setStatus("‚ö†Ô∏è WS error");

    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      if (data.type === "message" && data.chat_id === activeChatId) addMsg(data);
    };
  }

  function send(){
    const text = $("text").value.trim();
    if (!text) return;
    if (!token) return openAuth("login");
    if (!ws || ws.readyState !== 1) return addSystem("‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WS");
    ws.send(JSON.stringify({type:"message", text}));
    $("text").value = "";
  }

  function logout(){
    token = ""; me = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    localStorage.removeItem("activeChatId");

    if (ws) ws.close();
    ws = null;

    chats = [];
    activeChatId = "general";
    activeChatTitle = "general";

    $("chatlist").innerHTML = "";
    $("msgs").innerHTML = "";

    setStatus("");
    setWhoami();
    addSystem("üëã Logged out");

    closeSidebar();
    closePopovers();
    closeSheet();
    openAuth("login");
  }

  /* ===== Wiring ===== */
  $("btnToggleSidebar").onclick = () => toggleSidebar();
  $("drawerBackdrop").onclick = () => closeSidebar();
  window.addEventListener("resize", ()=> { if (!isMobile()) closeSidebar(); });

  $("btnOpenAuth").onclick = () => openAuth("login");
  $("btnLogout").onclick = () => logout();

  $("tabLogin").onclick = () => setAuthTab("login");
  $("tabRegister").onclick = () => setAuthTab("register");

  $("btnCloseAuth").onclick = () => { if (!token) return; closeAuth(); };
  $("btnAuthSubmit").onclick = () => authSubmit();
  $("authPassword").addEventListener("keydown", (e)=>{ if (e.key === "Enter") authSubmit(); });

  // Create buttons: mobile -> sheet, desktop -> popover
  $("btnOpenCreateGroup").onclick = () => {
    if (!token) return openAuth("login");
    if (isMobile()){
      closePopovers();
      openSheet("group");
    } else {
      closeSheet();
      toggleDesktopPopover("popGroup");
      setTimeout(()=> $("groupTitle").focus(), 30);
    }
  };

  $("btnOpenCreateDM").onclick = () => {
    if (!token) return openAuth("login");
    if (isMobile()){
      closePopovers();
      openSheet("dm");
    } else {
      closeSheet();
      toggleDesktopPopover("popDM");
      setTimeout(()=> $("dmUser").focus(), 30);
    }
  };

  $("btnCloseGroup").onclick = () => closePopovers();
  $("btnCloseDM").onclick = () => closePopovers();

  $("btnCreateGroup").onclick = async () => {
    try{
      const title = $("groupTitle").value;
      $("groupTitle").value = "";
      closePopovers();
      await createGroupChat(title);
      if (isMobile()) closeSidebar();
    }catch(e){ addSystem("‚ùå " + e.message); }
  };

  $("btnCreateDM").onclick = async () => {
    try{
      const u = $("dmUser").value;
      $("dmUser").value = "";
      closePopovers();
      await createDM(u);
      if (isMobile()) closeSidebar();
    }catch(e){ addSystem("‚ùå " + e.message); }
  };

  $("groupTitle").addEventListener("keydown", (e)=>{ if (e.key === "Enter") $("btnCreateGroup").click(); });
  $("dmUser").addEventListener("keydown", (e)=>{ if (e.key === "Enter") $("btnCreateDM").click(); });

  // Sheet
  $("btnCloseSheet").onclick = () => closeSheet();
  $("sheetOverlay").addEventListener("click", (e)=>{ if (e.target === $("sheetOverlay")) closeSheet(); });
  sheet.ok.onclick = async () => {
    try{
      const value = sheet.input.value;
      const mode = sheet.mode;
      closeSheet();
      if (mode === "group") await createGroupChat(value);
      if (mode === "dm") await createDM(value);
      if (isMobile()) closeSidebar();
    }catch(e){ addSystem("‚ùå " + e.message); }
  };
  sheet.input.addEventListener("keydown", (e)=>{ if (e.key === "Enter") sheet.ok.click(); });

  $("btnRefreshChats").onclick = () => refreshChats().catch(e=> addSystem("‚ùå " + e.message));
  $("btnLoadHistory").onclick = () => loadHistory().catch(e=> addSystem("‚ùå " + e.message));

  $("btnSend").onclick = () => send();
  $("text").addEventListener("keydown", (e)=>{ if (e.key === "Enter") send(); });

  // Arrow down
  $("msgs").addEventListener("scroll", ()=> updateToBottom(), { passive:true });
  toBottomBtn.onclick = () => { scrollToBottom($("msgs")); updateToBottom(); };

  // ESC
  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape"){
      closePopovers();
      closeSidebar();
      closeSheet();
    }
  });

  /* ===== Bootstrap session ===== */
  setWhoami();

  if (token){
    addSystem("üîÅ Checking session...");
    api("/api/me")
      .then(data => {
        me = data.username;
        localStorage.setItem("username", me);
        setWhoami();
        return refreshChats();
      })
      .then(() => {
        if (!chats.find(c => c.id === activeChatId)) activeChatId = "general";
        selectChat(activeChatId);
      })
      .catch(() => {
        token = "";
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("activeChatId");
        me = "";
        setWhoami();
        addSystem("üîê –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏ —Å–Ω–æ–≤–∞.");
        openAuth("login");
      });
  } else {
    addSystem("üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.");
    openAuth("login");
  }
</script>
</body>
</html>
