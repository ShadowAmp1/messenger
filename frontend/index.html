<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Messenger</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --border:#24304a;
      --muted:rgba(230,238,252,.85);
      --btn:#1b2742;
      --btn2:#12284a;
      --shadow: 0 18px 50px rgba(0,0,0,.5);
      --danger:#ff5b5b;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: system-ui, Arial;
      background: var(--bg);
      color:#e6eefc;
      overflow: hidden;
    }

    .wrap{
      height: 100dvh;
      padding: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    @supports (-webkit-touch-callout: none) {
      html{ height: -webkit-fill-available; }
      .wrap{ height: -webkit-fill-available; }
    }

    .card{
      width: min(1100px, 100%);
      height: calc(100dvh - 32px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 0;
    }

    .top{
      flex: 0 0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      padding: calc(10px + env(safe-area-inset-top)) 12px 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(18,26,43,.92);
      backdrop-filter: blur(6px);
      z-index: 50;
    }
    .top-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand{ font-weight:700; white-space:nowrap; }
    .pill{
      font-size:12px; opacity:.95;
      padding: 4px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#0b1220;
      white-space:nowrap;
      max-width: 46vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .small{ font-size:12px; opacity:.85; color: var(--muted); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .btn{
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform: translateY(1px); }

    .grid{
      flex: 1 1 auto;
      min-height: 0;
      display:grid;
      grid-template-columns: 330px 1fr;
      height: auto;
    }

    .sidebar{
      min-height: 0;
      border-right: 1px solid var(--border);
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 12px;
      overflow: hidden;
      background: var(--card);
    }
    .sep{ height: 1px; background: var(--border); opacity:.8; margin: 6px 0; }

    .chatlist{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      overscroll-behavior: contain;
      display:flex;
      flex-direction: column;
      gap: 6px;
      padding-right: 4px;
    }

    .chatitem{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:8px;
      padding: 12px 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background:#0b1220;
      cursor:pointer;
      min-width: 0;
      touch-action: manipulation;
    }
    .chatitem:hover{ filter:brightness(1.08); }
    .chatitem.active{ background: var(--btn2); }

    .title{ font-weight:650; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sub{ font-size:11px; opacity:.75; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badge{ font-size:11px; opacity:.9; padding:2px 8px; border:1px solid var(--border); border-radius:999px; }

    .iconbar{ display:flex; gap:8px; }
    .iconbtn{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .iconbtn:hover{ filter:brightness(1.12); }
    .iconbtn:active{ transform: translateY(1px); }

    .chat{
      min-height: 0;
      display:flex;
      flex-direction: column;
      overflow:hidden;
      position: relative;
    }

    .msgs{
      flex: 1 1 auto;
      min-height: 0;
      overflow:auto;
      overscroll-behavior: contain;
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg{
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background:#0b1220;
      word-break: break-word;
    }
    .me{ align-self: flex-end; background: var(--btn2); }
    .meta{ font-size: 12px; opacity:.8; margin-bottom: 4px; }

    .media{
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      width: 100%;
      max-width: 420px;
      background: rgba(0,0,0,.12);
    }
    .media img{ width:100%; display:block; }
    .media video{ width:100%; display:block; }
    .media audio{ width:100%; display:block; padding: 10px; }

    .composer{
      flex: 0 0 auto;
      display:flex;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: rgba(11,18,32,.75);
      backdrop-filter: blur(6px);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      align-items: center;
    }
    .composer input{
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px;
      min-width: 0;
    }
    .composer button{
      min-width: 86px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      touch-action: manipulation;
    }

    #btnAttach, #btnRec{
      min-width: 46px;
      padding: 12px 14px;
    }

    /* Recording state */
    #btnRec.rec{
      border-color: rgba(255,91,91,.65);
      box-shadow: 0 0 0 2px rgba(255,91,91,.12) inset;
      position: relative;
    }
    #btnRec.rec::after{
      content:"";
      width:10px;height:10px;
      border-radius:999px;
      background: var(--danger);
      position:absolute;
      top: 8px;
      right: 8px;
      box-shadow: 0 0 12px rgba(255,91,91,.55);
    }
    .rec-timer{
      font-size: 12px;
      opacity: .9;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#0b1220;
      white-space: nowrap;
      display:none;
    }
    .rec-timer.show{ display:inline-flex; }

    .to-bottom{
      position:absolute;
      right: 12px;
      bottom: calc(12px + 60px + env(safe-area-inset-bottom));
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(11,18,32,.92);
      color:#e6eefc;
      display:none;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
      user-select:none;
      touch-action: manipulation;
      z-index: 30;
    }
    .to-bottom.show{ display:grid; }

    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 999;
      padding: 18px;
    }
    .modal-overlay.open{ display:grid; place-items:center; }

    .modal{
      width: min(520px, 100%);
      background: var(--card);
      border:1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .modal-top{
      padding: 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
    }
    .tabs{ display:flex; gap:8px; }
    .tab{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background:#0b1220;
      cursor:pointer;
      font-size: 13px;
      opacity:.95;
      user-select:none;
      touch-action: manipulation;
    }
    .tab.active{ background: var(--btn2); }
    .modal-body{ padding: 14px; display:flex; flex-direction: column; gap: 10px; }
    .modal-body input{
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px;
    }
    .modal-body .btnrow{ display:flex; gap:10px; margin-top: 6px; }
    .modal-body button{
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      flex:1;
      touch-action: manipulation;
    }
    .err{ font-size: 12px; color:#ffd3d3; opacity:.95; display:none; }
    .modal-hint{ font-size: 12px; opacity:.85; color: var(--muted); }
    .xbtn{
      width:32px; height:32px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      cursor:pointer;
    }

    .mobile-only{ display:none; }

    .drawer-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 120;
    }
    .drawer-backdrop.open{ display:block; }

    .sheet-overlay{
      position: fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      z-index: 400;
      padding: 12px;
    }
    .sheet-overlay.open{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sheet{
      width: min(520px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .sheet-top{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
    }
    .sheet-body{
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .sheet-body input{
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      outline:none;
      font-size: 16px;
    }
    .sheet-actions{ display:flex; gap:10px; margin-top: 6px; }
    .sheet-actions button{
      flex:1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      cursor:pointer;
      touch-action: manipulation;
    }

    @media (max-width: 900px){
      .wrap{ padding: 0; height: 100dvh; }
      .card{
        width: 100%;
        height: 100dvh;
        border-radius: 0;
        border-left: 0;
        border-right: 0;
      }
      .grid{ grid-template-columns: 1fr; }

      .mobile-only{ display:inline-flex; }
      .brand{ display:none; }

      .sidebar{
        position: fixed;
        top: 0;
        left: 0;
        width: min(360px, 92vw);
        height: 100dvh;
        transform: translateX(-110%);
        transition: transform .2s ease;
        z-index: 130;
        box-shadow: 0 18px 50px rgba(0,0,0,.45);
        padding-top: calc(58px + env(safe-area-inset-top));
      }
      .sidebar.open{ transform: translateX(0); }

      .msgs{ padding: 12px; }
      .msg{ max-width: 92%; }

      .sheet-overlay.open{ align-items:flex-end; justify-content:center; }
      .sheet{ border-radius: 18px 18px 0 0; }
    }
  </style>
</head>

<body>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <div class="wrap" id="appRoot">
    <div class="card">
      <div class="top">
        <div class="top-left">
          <button class="btn mobile-only" id="btnToggleSidebar" type="button">‚ò∞ Chats</button>
          <div class="brand">Mini Messenger</div>
          <div class="pill" id="whoami">not logged in</div>
          <div class="small" id="status"></div>
        </div>
        <div class="row">
          <button class="btn" id="btnOpenAuth" type="button">Login / Register</button>
          <button class="btn" id="btnLogout" type="button" style="display:none;">Logout</button>
        </div>
      </div>

      <div class="grid">
        <div class="sidebar" id="sidebar">
          <div class="row" style="justify-content: space-between;">
            <div><b>Chats</b></div>
            <div class="iconbar">
              <div class="iconbtn" id="btnOpenCreateGroup" title="New group chat">‚ûï</div>
              <div class="iconbtn" id="btnOpenCreateDM" title="New DM">üí¨</div>
              <div class="iconbtn" id="btnRefreshChats" title="Refresh chats">‚ü≥</div>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn" id="btnLoadHistory" type="button">Load history</button>
          </div>

          <div class="sep"></div>

          <div class="chatlist" id="chatlist"></div>

          <div class="small" style="margin-top:auto;">
            –°–æ–≤–µ—Ç—ã: ‚ûï –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç, üí¨ DM, ‚ü≥ –æ–±–Ω–æ–≤–∏—Ç—å. üìé ‚Äî —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ. üéôÔ∏è ‚Äî –≥–æ–ª–æ—Å–æ–≤–æ–µ.
          </div>
        </div>

        <div class="chat" id="chatArea">
          <div class="msgs" id="msgs"></div>
          <div class="to-bottom" id="btnToBottom" title="–í–Ω–∏–∑">‚¨áÔ∏è</div>

          <div class="composer">
            <button id="btnAttach" type="button" title="–§–æ—Ç–æ/–í–∏–¥–µ–æ/–ê—É–¥–∏–æ">üìé</button>
            <input id="file" type="file" accept="image/*,video/*,audio/*" style="display:none" />

            <button id="btnRec" type="button" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ">üéôÔ∏è</button>
            <div class="rec-timer" id="recTimer">‚óè 00:00</div>

            <input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button id="btnSend" type="button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal-overlay" id="authOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-top">
        <div class="tabs">
          <div class="tab active" id="tabLogin">Login</div>
          <div class="tab" id="tabRegister">Register</div>
        </div>
        <button class="xbtn" id="btnCloseAuth" type="button" title="Close">‚úï</button>
      </div>
      <div class="modal-body">
        <input id="authUsername" placeholder="username (3-20: a-z 0-9 _)" autocomplete="username" />
        <input id="authPassword" placeholder="password (–º–∏–Ω 6)" type="password" autocomplete="current-password" />
        <div class="err" id="authError"></div>
        <div class="btnrow">
          <button id="btnAuthSubmit" type="button">Login</button>
        </div>
        <div class="modal-hint">
          –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </div>
      </div>
    </div>
  </div>

  <!-- CREATE SHEET -->
  <div class="sheet-overlay" id="sheetOverlay" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheet-top">
        <b id="sheetTitle">–°–æ–∑–¥–∞—Ç—å</b>
        <button class="xbtn" id="btnCloseSheet" type="button">‚úï</button>
      </div>
      <div class="sheet-body">
        <input id="sheetInput" placeholder="" />
        <div class="sheet-actions">
          <button id="btnSheetOk" type="button">OK</button>
        </div>
        <div class="small" id="sheetHint" style="opacity:.85;"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let ws = null;

  let chats = [];
  let activeChatId = localStorage.getItem("activeChatId") || "";
  let activeChatTitle = "";

  function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }

  /* ===== Drawer ===== */
  const sidebar = $("sidebar");
  const backdrop = $("drawerBackdrop");
  function openSidebar(){ sidebar.classList.add("open"); backdrop.classList.add("open"); }
  function closeSidebar(){ sidebar.classList.remove("open"); backdrop.classList.remove("open"); }
  function toggleSidebar(){ sidebar.classList.contains("open") ? closeSidebar() : openSidebar(); }

  /* ===== Scroll + arrow ===== */
  const toBottomBtn = $("btnToBottom");
  function isNearBottom(el, px=160){
    return (el.scrollHeight - el.scrollTop - el.clientHeight) < px;
  }
  function scrollToBottom(el){ el.scrollTop = el.scrollHeight; }
  function updateToBottom(){
    const box = $("msgs");
    toBottomBtn.classList.toggle("show", !isNearBottom(box));
  }

  /* ===== UI helpers ===== */
  function setStatus(s){ $("status").textContent = s; }
  function setWhoami(){
    $("whoami").textContent = me ? `üë§ ${me}` : "not logged in";
    $("btnLogout").style.display = me ? "" : "none";
    $("btnOpenAuth").style.display = me ? "none" : "";
  }

  function addSystem(text){
    const box = $("msgs");
    const stick = isNearBottom(box);
    const div = document.createElement("div");
    div.className = "msg";
    div.style.opacity = ".85";
    div.textContent = text;
    box.appendChild(div);
    if (stick) scrollToBottom(box);
    updateToBottom();
  }

  function addMsg(m){
    const {sender, text, created_at, media_kind, media_url, media_name} = m;

    const box = $("msgs");
    const stick = isNearBottom(box);

    const div = document.createElement("div");
    div.className = "msg" + (sender === me ? " me" : "");

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${sender} ‚Ä¢ ${new Date(created_at * 1000).toLocaleTimeString()}`;
    div.appendChild(meta);

    if (media_url && media_kind === "image"){
      const wrap = document.createElement("div");
      wrap.className = "media";
      const img = document.createElement("img");
      img.src = media_url;
      img.alt = media_name || "image";
      img.loading = "lazy";
      img.style.cursor = "pointer";
      img.onclick = () => window.open(media_url, "_blank");
      wrap.appendChild(img);
      div.appendChild(wrap);
    }

    if (media_url && media_kind === "video"){
      const wrap = document.createElement("div");
      wrap.className = "media";
      const video = document.createElement("video");
      video.src = media_url;
      video.controls = true;
      video.preload = "metadata";
      wrap.appendChild(video);
      div.appendChild(wrap);
    }

    if (media_url && media_kind === "audio"){
      const wrap = document.createElement("div");
      wrap.className = "media";
      const audio = document.createElement("audio");
      audio.src = media_url;
      audio.controls = true;
      audio.preload = "metadata";
      wrap.appendChild(audio);
      div.appendChild(wrap);
    }

    if (text){
      const body = document.createElement("div");
      body.textContent = text;
      body.style.marginTop = (media_url ? "8px" : "0");
      div.appendChild(body);
    }

    box.appendChild(div);

    if (stick) scrollToBottom(box);
    updateToBottom();
  }

  async function api(path, method="GET", body=null){
    const opts = { method, headers: {} };
    if (token) opts.headers["Authorization"] = `Bearer ${token}`;
    if (body){
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(path, opts);
    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { data = { detail: raw }; }
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${data.detail || raw}`);
    return data;
  }

  /* ===== AUTH ===== */
  let authMode = "login";
  function openAuth(mode="login"){
    authMode = mode;
    $("authOverlay").classList.add("open");
    $("authOverlay").setAttribute("aria-hidden","false");
    $("authError").style.display = "none";
    $("authError").textContent = "";
    setAuthTab(mode);
    $("authUsername").value = me || $("authUsername").value || "";
    $("authPassword").value = "";
    setTimeout(()=> $("authUsername").focus(), 50);
  }
  function closeAuth(){
    $("authOverlay").classList.remove("open");
    $("authOverlay").setAttribute("aria-hidden","true");
  }
  function setAuthTab(mode){
    authMode = mode;
    $("tabLogin").classList.toggle("active", mode==="login");
    $("tabRegister").classList.toggle("active", mode==="register");
    $("btnAuthSubmit").textContent = (mode==="login") ? "Login" : "Register";
    $("authPassword").setAttribute("autocomplete", mode==="login" ? "current-password" : "new-password");
  }
  function authError(msg){
    $("authError").style.display = "";
    $("authError").textContent = msg;
  }
  async function authSubmit(){
    const username = $("authUsername").value.trim();
    const password = $("authPassword").value;

    $("authError").style.display="none";
    $("authError").textContent="";

    try{
      if (authMode === "register"){
        await api("/api/register", "POST", {username, password});
      }
      const data = await api("/api/login", "POST", {username, password});
      token = data.token;
      me = data.username;

      localStorage.setItem("token", token);
      localStorage.setItem("username", me);

      setWhoami();
      closeAuth();
      addSystem(`‚úÖ Logged in as ${me}`);

      await refreshChats(true);
    }catch(e){
      authError(e.message);
    }
  }

  /* ===== Create sheet ===== */
  const sheet = {
    overlay: $("sheetOverlay"),
    title: $("sheetTitle"),
    input: $("sheetInput"),
    hint: $("sheetHint"),
    ok: $("btnSheetOk"),
    mode: null
  };

  function openSheet(mode){
    sheet.mode = mode;
    sheet.overlay.classList.add("open");
    sheet.overlay.setAttribute("aria-hidden","false");

    if (mode === "group"){
      sheet.title.textContent = "–ù–æ–≤—ã–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç";
      sheet.input.placeholder = "–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: work)";
      sheet.hint.textContent = "–°–æ–∑–¥–∞—Å—Ç —á–∞—Ç –∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç —Ç–µ–±—è –≤ –Ω–µ–≥–æ.";
      sheet.ok.textContent = "Create";
    } else {
      sheet.title.textContent = "–ù–æ–≤—ã–π DM";
      sheet.input.placeholder = "Username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è";
      sheet.hint.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.";
      sheet.ok.textContent = "Open DM";
    }
    sheet.input.value = "";
    setTimeout(()=> sheet.input.focus(), 50);
  }

  function closeSheet(){
    sheet.overlay.classList.remove("open");
    sheet.overlay.setAttribute("aria-hidden","true");
    sheet.mode = null;
  }

  async function createGroupChat(title){
    const t = (title || "").trim();
    if (!t) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞.");
    const data = await api("/api/chats", "POST", {title: t});
    addSystem(`‚úÖ Created: ${data.chat.title}`);
    await refreshChats(false);
    selectChat(data.chat.id);
  }

  async function createDM(user){
    const u = (user || "").trim();
    if (!u) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ username.");
    const data = await api("/api/chats/dm", "POST", {username: u});
    addSystem(`‚úÖ ${data.chat.title}`);
    await refreshChats(false);
    selectChat(data.chat.id);
  }

  /* ===== Media upload (image/video/audio/voice) ===== */
  async function uploadMedia(file){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");

    const caption = $("text").value.trim();

    const maxBytes = 25 * 1024 * 1024;
    if (file.size > maxBytes){
      addSystem("‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–ª–∏–º–∏—Ç 25MB).");
      $("file").value = "";
      return;
    }

    const fd = new FormData();
    fd.append("chat_id", activeChatId);
    fd.append("text", caption);
    fd.append("file", file);

    setStatus("‚è´ Upload...");

    const res = await fetch("/api/upload", {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: fd,
    });

    const raw = await res.text();
    let data = {};
    try { data = JSON.parse(raw); } catch { data = { detail: raw }; }

    if (!res.ok){
      setStatus("");
      throw new Error(data.detail || raw);
    }

    $("text").value = "";
    $("file").value = "";

    if (!ws || ws.readyState !== 1){
      if (data.message) addMsg(data.message);
    }

    setStatus(`üü¢ WS ‚Ä¢ ${activeChatTitle}`);
  }

  /* ===== Voice recording ===== */
  const btnRec = $("btnRec");
  const recTimer = $("recTimer");

  let rec = {
    active: false,
    mediaRecorder: null,
    chunks: [],
    t0: 0,
    timerId: null,
    stream: null,
    mime: "",
    ext: "webm",
  };

  function fmtTime(sec){
    const m = String(Math.floor(sec/60)).padStart(2,"0");
    const s = String(Math.floor(sec%60)).padStart(2,"0");
    return `${m}:${s}`;
  }

  function pickMime(){
    // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: opus/webm -> ogg -> mp4 (iOS —á–∞—Å—Ç–æ)
    const candidates = [
      "audio/webm;codecs=opus",
      "audio/webm",
      "audio/ogg;codecs=opus",
      "audio/ogg",
      "audio/mp4",
      "audio/aac",
      "audio/wav",
    ];
    if (!window.MediaRecorder) return "";
    for (const c of candidates){
      try{
        if (MediaRecorder.isTypeSupported(c)) return c;
      }catch(_){}
    }
    return "";
  }

  function mimeToExt(m){
    m = (m||"").toLowerCase();
    if (m.includes("mp4")) return "m4a";
    if (m.includes("aac")) return "aac";
    if (m.includes("ogg")) return "ogg";
    if (m.includes("wav")) return "wav";
    return "webm";
  }

  async function startRecording(){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      addSystem("‚ö†Ô∏è –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
      return;
    }
    if (!window.MediaRecorder){
      addSystem("‚ö†Ô∏è MediaRecorder –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
      return;
    }

    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mime = pickMime();
      const mr = new MediaRecorder(stream, mime ? { mimeType: mime } : undefined);

      rec.active = true;
      rec.mediaRecorder = mr;
      rec.chunks = [];
      rec.t0 = Date.now();
      rec.stream = stream;
      rec.mime = mime || mr.mimeType || "audio/webm";
      rec.ext = mimeToExt(rec.mime);

      btnRec.classList.add("rec");
      btnRec.textContent = "‚èπÔ∏è";
      recTimer.classList.add("show");
      recTimer.textContent = `‚óè 00:00`;

      rec.timerId = setInterval(()=>{
        const sec = (Date.now() - rec.t0) / 1000;
        recTimer.textContent = `‚óè ${fmtTime(sec)}`;
      }, 250);

      mr.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) rec.chunks.push(e.data);
      };

      mr.onstop = async () => {
        try{
          const blob = new Blob(rec.chunks, { type: rec.mime || "audio/webm" });
          const fname = `voice_${Date.now()}.${rec.ext}`;
          const file = new File([blob], fname, { type: rec.mime || "audio/webm" });
          await uploadMedia(file);
        }catch(e){
          addSystem("‚ùå " + (e.message || e));
        }
      };

      mr.start();
      setStatus(`üéôÔ∏è Recording... ${activeChatTitle}`);
    }catch(e){
      addSystem("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω: " + (e.message || e));
    }
  }

  function stopRecording(){
    if (!rec.active) return;

    rec.active = false;
    setStatus(`üü¢ WS ‚Ä¢ ${activeChatTitle}`);

    btnRec.classList.remove("rec");
    btnRec.textContent = "üéôÔ∏è";
    recTimer.classList.remove("show");

    if (rec.timerId){ clearInterval(rec.timerId); rec.timerId = null; }

    try{
      if (rec.mediaRecorder && rec.mediaRecorder.state !== "inactive"){
        rec.mediaRecorder.stop();
      }
    }catch(_){}

    try{
      if (rec.stream){
        for (const t of rec.stream.getTracks()) t.stop();
      }
    }catch(_){}

    rec.mediaRecorder = null;
    rec.stream = null;
  }

  btnRec.onclick = () => {
    if (rec.active) stopRecording();
    else startRecording();
  };

  /* ===== Chats ===== */
  function renderChatList(){
    const list = $("chatlist");
    list.innerHTML = "";

    for (const c of chats){
      const item = document.createElement("div");
      item.className = "chatitem" + (c.id === activeChatId ? " active" : "");

      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";
      left.style.minWidth = "0";

      let title = c.title || c.id;
      let typeLabel = c.type || "chat";

      if (c.type === "dm" && c.title && c.title.startsWith("dm:")){
        const parts = c.title.slice(3).split("|");
        if (parts.length === 2){
          const other = parts[0] === me ? parts[1] : parts[0];
          title = `DM: ${other}`;
        }
      }

      const t1 = document.createElement("div");
      t1.className = "title";
      t1.textContent = title;

      const t2 = document.createElement("div");
      t2.className = "sub";
      t2.textContent = c.id;

      left.appendChild(t1);
      left.appendChild(t2);

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = typeLabel;

      item.appendChild(left);
      item.appendChild(badge);

      item.onclick = () => {
        selectChat(c.id);
        if (isMobile()) closeSidebar();
      };

      list.appendChild(item);
    }
  }

  async function refreshChats(selectIfNeeded){
    if (!token){ openAuth("login"); return; }

    const data = await api("/api/chats");
    chats = (data.chats || []);
    renderChatList();

    if (!chats.length){
      activeChatId = "";
      activeChatTitle = "";
      localStorage.removeItem("activeChatId");
      $("msgs").innerHTML = "";
      addSystem("‚ÑπÔ∏è –£ —Ç–µ–±—è –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –∏–ª–∏ DM.");
      setStatus("");
      if (ws) { ws.close(); ws = null; }
      return;
    }

    if (selectIfNeeded){
      if (!activeChatId || !chats.find(c => c.id === activeChatId)){
        activeChatId = chats[0].id;
        localStorage.setItem("activeChatId", activeChatId);
      }
      selectChat(activeChatId);
    }
  }

  function selectChat(chatId){
    if (rec.active) stopRecording();

    activeChatId = chatId;
    localStorage.setItem("activeChatId", activeChatId);

    const found = chats.find(c => c.id === chatId);
    if (found){
      activeChatTitle = found.title || found.id;
      if (found.type === "dm" && found.title && found.title.startsWith("dm:")){
        const parts = found.title.slice(3).split("|");
        if (parts.length === 2){
          const other = parts[0] === me ? parts[1] : parts[0];
          activeChatTitle = `DM: ${other}`;
        }
      }
    } else {
      activeChatTitle = chatId;
    }

    $("msgs").innerHTML = "";
    addSystem(`üìå Chat: ${activeChatTitle}`);

    renderChatList();
    connectWS();
    loadHistory();
  }

  /* ===== Messages ===== */
  async function loadHistory(){
    if (!token) return openAuth("login");
    if (!activeChatId) return;

    const box = $("msgs");
    box.innerHTML = "";
    addSystem(`üì• Loading: ${activeChatTitle}...`);

    try{
      const data = await api(`/api/messages?chat_id=${encodeURIComponent(activeChatId)}`);
      box.innerHTML = "";
      for (const m of (data.messages || [])) addMsg(m);
      scrollToBottom(box);
      updateToBottom();
    } catch (e) {
      if (String(e.message).includes("403")) {
        addSystem("‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —á–∞—Ç—É. –ü–µ—Ä–µ–∫–ª—é—á–∞—é –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—ã–π...");
        await refreshChats(false);
        if (chats.length) selectChat(chats[0].id);
        return;
      }
      addSystem("‚ùå " + e.message);
    }
  }

  function connectWS(){
    if (!token) return openAuth("login");
    if (!activeChatId) return;

    if (ws) ws.close();

    const proto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${proto}://${location.host}/ws?token=${encodeURIComponent(token)}&chat_id=${encodeURIComponent(activeChatId)}`);

    ws.onopen = () => setStatus(`üü¢ WS ‚Ä¢ ${activeChatTitle}`);
    ws.onclose = () => setStatus("üî¥ WS disconnected");
    ws.onerror = () => setStatus("‚ö†Ô∏è WS error");

    ws.onmessage = (ev) => {
      let data;
      try { data = JSON.parse(ev.data); } catch { return; }
      if (data.type === "message" && data.chat_id === activeChatId) addMsg(data);
    };
  }

  function send(){
    const text = $("text").value.trim();
    if (!text) return;
    if (!token) return openAuth("login");
    if (rec.active) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–ø–∏—Å—å üéôÔ∏è");
    if (!ws || ws.readyState !== 1) return addSystem("‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WS");
    ws.send(JSON.stringify({type:"message", text}));
    $("text").value = "";
  }

  function logout(){
    if (rec.active) stopRecording();

    token = ""; me = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    localStorage.removeItem("activeChatId");

    if (ws) ws.close();
    ws = null;

    chats = [];
    activeChatId = "";
    activeChatTitle = "";

    $("chatlist").innerHTML = "";
    $("msgs").innerHTML = "";

    setStatus("");
    setWhoami();
    addSystem("üëã Logged out");

    closeSidebar();
    closeSheet();
    openAuth("login");
  }

  /* ===== Swipe (mobile) ===== */
  function setupSwipe(){
    const root = $("appRoot");
    let startX = 0, startY = 0, tracking = false, startedOnEdge = false;

    root.addEventListener("touchstart", (e) => {
      if (!isMobile()) return;
      if (!e.touches || e.touches.length !== 1) return;
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
      tracking = true;
      startedOnEdge = startX <= 24;
    }, { passive:true });

    root.addEventListener("touchmove", (e) => {
      if (!tracking || !isMobile()) return;
      if (!e.touches || e.touches.length !== 1) return;
      const t = e.touches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      if (Math.abs(dy) > Math.abs(dx)) return;

      if (startedOnEdge && dx > 40) {
        openSidebar();
        tracking = false;
      }

      if (sidebar.classList.contains("open") && dx < -40) {
        closeSidebar();
        tracking = false;
      }
    }, { passive:true });

    root.addEventListener("touchend", ()=> { tracking = false; }, { passive:true });
    root.addEventListener("touchcancel", ()=> { tracking = false; }, { passive:true });
  }

  /* ===== Wiring ===== */
  $("btnToggleSidebar").onclick = () => toggleSidebar();
  $("drawerBackdrop").onclick = () => closeSidebar();
  window.addEventListener("resize", ()=> { if (!isMobile()) closeSidebar(); });

  $("btnOpenAuth").onclick = () => openAuth("login");
  $("btnLogout").onclick = () => logout();

  $("tabLogin").onclick = () => setAuthTab("login");
  $("tabRegister").onclick = () => setAuthTab("register");

  $("btnCloseAuth").onclick = () => { if (!token) return; closeAuth(); };
  $("btnAuthSubmit").onclick = () => authSubmit();
  $("authPassword").addEventListener("keydown", (e)=>{ if (e.key === "Enter") authSubmit(); });

  $("btnOpenCreateGroup").onclick = () => {
    if (!token) return openAuth("login");
    openSheet("group");
  };
  $("btnOpenCreateDM").onclick = () => {
    if (!token) return openAuth("login");
    openSheet("dm");
  };

  $("btnCloseSheet").onclick = () => closeSheet();
  $("sheetOverlay").addEventListener("click", (e)=>{ if (e.target === $("sheetOverlay")) closeSheet(); });

  $("btnSheetOk").onclick = async () => {
    try{
      const value = sheet.input.value;
      const mode = sheet.mode;
      closeSheet();
      if (mode === "group") await createGroupChat(value);
      if (mode === "dm") await createDM(value);
      if (isMobile()) closeSidebar();
    }catch(e){ addSystem("‚ùå " + e.message); }
  };
  sheet.input.addEventListener("keydown", (e)=>{ if (e.key === "Enter") $("btnSheetOk").click(); });

  $("btnRefreshChats").onclick = () => refreshChats(false).catch(e=> addSystem("‚ùå " + e.message));
  $("btnLoadHistory").onclick = () => loadHistory().catch(e=> addSystem("‚ùå " + e.message));

  $("btnSend").onclick = () => send();
  $("text").addEventListener("keydown", (e)=>{ if (e.key === "Enter") send(); });

  $("btnAttach").onclick = () => $("file").click();
  $("file").addEventListener("change", async () => {
    const f = $("file").files && $("file").files[0];
    if (!f) return;
    try{
      await uploadMedia(f);
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  });

  $("msgs").addEventListener("scroll", ()=> updateToBottom(), { passive:true });
  toBottomBtn.onclick = () => { scrollToBottom($("msgs")); updateToBottom(); };

  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape"){
      if (rec.active) stopRecording();
      closeSidebar();
      closeSheet();
    }
  });

  setupSwipe();
  setWhoami();

  /* ===== Bootstrap session ===== */
  if (token){
    addSystem("üîÅ Checking session...");
    api("/api/me")
      .then(data => {
        me = data.username;
        localStorage.setItem("username", me);
        setWhoami();
        return refreshChats(true);
      })
      .catch(() => {
        token = "";
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("activeChatId");
        me = "";
        setWhoami();
        addSystem("üîê –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏ —Å–Ω–æ–≤–∞.");
        openAuth("login");
      });
  } else {
    addSystem("üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.");
    openAuth("login");
  }
</script>
</body>
</html>
