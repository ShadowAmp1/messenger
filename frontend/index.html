<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Mini Messenger</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --border:#24304a;
      --muted:rgba(230,238,252,.85);
      --btn:#1b2742;
      --btn2:#12284a;
      --shadow: 0 18px 50px rgba(0,0,0,.5);
      --danger:#ff5b5b;
    }

    *{ box-sizing:border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: system-ui, Arial;
      background: var(--bg);
      color:#e6eefc;
      overflow: hidden;
    }

    .wrap{
      height: 100dvh;
      padding: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    @supports (-webkit-touch-callout: none) {
      html{ height: -webkit-fill-available; }
      .wrap{ height: -webkit-fill-available; }
    }

    .card{
      width: min(1100px, 100%);
      height: calc(100dvh - 32px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display:flex;
      flex-direction: column;
      min-height: 0;
      box-shadow: var(--shadow);
    }

    header{
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      background: rgba(0,0,0,.08);
    }
    header .left{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
    }
    header .right{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    header .title{
      font-weight: 700;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    header .sub{
      opacity: .85;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }

    .btn{
      border: 1px solid var(--border);
      background: var(--btn);
      color:#e6eefc;
      border-radius: 10px;
      padding: 10px 12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-weight: 650;
    }
    .btn:hover{ filter: brightness(1.07); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: var(--btn2); }
    .btn.danger{ background: rgba(255,91,91,.14); border-color: rgba(255,91,91,.35); color:#ffdede; }

    .iconbtn{
      width: 42px;
      height: 42px;
      display:grid;
      place-items:center;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--btn);
      cursor:pointer;
      user-select:none;
      font-size: 18px;
    }
    .iconbtn:hover{ filter: brightness(1.07); }
    .iconbtn:active{ transform: translateY(1px); }

    .main{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 330px 1fr;
    }

    /* Sidebar */
    aside{
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,.06);
      min-height:0;
      display:flex;
      flex-direction: column;
    }
    .asideTop{
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .searchRow{
      display:flex;
      gap: 8px;
    }
    input, textarea{
      width: 100%;
      background: rgba(255,255,255,.03);
      color:#e6eefc;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    input:focus, textarea:focus{
      border-color: rgba(140,170,255,.55);
      box-shadow: 0 0 0 3px rgba(120,160,255,.10);
    }
    .chats{
      overflow:auto;
      padding: 8px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    .chat{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .chat:hover{ filter: brightness(1.06); }
    .chat.active{
      outline: 2px solid rgba(120,160,255,.35);
      background: rgba(120,160,255,.08);
    }
    .chat .dot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(140,170,255,.65);
      flex: 0 0 auto;
    }
    .chat .meta{
      min-width:0;
      flex:1;
    }
    .chat .meta .t{
      font-weight: 750;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat .meta .s{
      font-size: 12px;
      opacity: .85;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    /* Content */
    section{
      min-height:0;
      display:flex;
      flex-direction: column;
    }

    .msgs{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }
    .msg{
      max-width: min(680px, 92%);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .msg.me{
      align-self: flex-end;
      background: rgba(120,160,255,.10);
      border-color: rgba(120,160,255,.25);
    }
    .msg .top{
      display:flex;
      align-items:baseline;
      justify-content: space-between;
      gap: 10px;
    }
    .msg .user{
      font-weight: 800;
      opacity: .95;
      font-size: 13px;
    }
    .msg .time{
      font-size: 12px;
      opacity: .75;
      color: var(--muted);
      flex: 0 0 auto;
    }
    .msg .text{
      white-space: pre-wrap;
      line-height: 1.35;
    }

    .media{
      margin-top: 6px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
    }
    .media img, .media video{
      width: 100%;
      max-height: 420px;
      object-fit: cover;
      display:block;
    }
    audio{
      width: 100%;
      display:block;
      padding: 8px;
    }

    .composer{
      border-top: 1px solid var(--border);
      padding: 12px;
      display:flex;
      gap: 10px;
      align-items: flex-end;
      background: rgba(0,0,0,.08);
    }
    .composer textarea{
      resize:none;
      min-height: 42px;
      max-height: 120px;
      line-height: 1.25;
    }
    .composer .right{
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .status{
      padding: 10px 14px;
      border-top: 1px solid var(--border);
      font-size: 13px;
      color: var(--muted);
      background: rgba(0,0,0,.08);
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Drawer (mobile) */
    .drawerBackdrop{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 20;
    }
    .drawerBackdrop.open{ display:block; }

    @media (max-width: 900px){
      .main{
        grid-template-columns: 1fr;
      }
      aside{
        position: fixed;
        left: 0; top: 0; bottom: 0;
        width: min(92vw, 360px);
        transform: translateX(-110%);
        transition: transform .25s ease;
        z-index: 30;
        border-right: 1px solid var(--border);
        box-shadow: var(--shadow);
      }
      aside.open{ transform: translateX(0); }
      header .title{ max-width: 44vw; }
      header .sub{ display:none; }
    }

    /* To bottom button */
    .toBottom{
      position: absolute;
      right: 20px;
      bottom: 90px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      transform: translateY(6px);
    }
    .toBottom.show{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    /* Auth modal */
    .modal{
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
      background: rgba(0,0,0,.55);
      z-index: 50;
    }
    .modal.open{ display:flex; }
    .modal .box{
      width: min(420px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .modal .row{
      display:flex;
      gap: 10px;
    }
    .modal .tabs{
      display:flex;
      gap: 10px;
    }
    .tab{
      flex:1;
      text-align:center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      user-select:none;
      font-weight: 700;
    }
    .tab.active{
      background: rgba(120,160,255,.10);
      border-color: rgba(120,160,255,.25);
      outline: 2px solid rgba(120,160,255,.20);
    }
    .hint{
      font-size: 13px;
      color: var(--muted);
      opacity: .9;
    }
    .link{
      color:#bcd0ff;
      cursor:pointer;
      user-select:none;
      text-decoration: underline;
      text-underline-offset: 3px;
    }

    /* Recording UI */
    .recBadge{
      display:none;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,91,91,.35);
      background: rgba(255,91,91,.10);
      color:#ffdede;
      font-weight: 700;
    }
    .recBadge.show{ display:inline-flex; }
    .blink{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--danger);
      box-shadow: 0 0 0 6px rgba(255,91,91,.12);
      animation: blink 1.1s infinite;
    }
    @keyframes blink{
      0%, 100%{ opacity: .2; }
      50%{ opacity: 1; }
    }

    /* ==== Voice message UI ==== */
    .voice{
      display:flex;
      align-items:center;
      gap:10px;
      max-width: 420px;
    }
    .voice .play{
      width:38px;height:38px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0b1220;
      color:#e6eefc;
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      flex: 0 0 auto;
    }
    .voice .play:active{ transform: translateY(1px); }
    .voice .wave{
      flex: 1 1 auto;
      min-width: 160px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .voice canvas{
      width: 100%;
      height: 34px;
      display:block;
      border-radius: 10px;
      background: rgba(0,0,0,.12);
      border: 1px solid var(--border);
      cursor: pointer;
    }
    .voice .time{
      display:flex;
      justify-content: space-between;
      font-size: 12px;
      opacity: .85;
      color: var(--muted);
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="drawerBackdrop" id="drawerBackdrop"></div>

  <div class="wrap">
    <div class="card">
      <header>
        <div class="left">
          <div class="iconbtn" id="btnMenu" title="–ú–µ–Ω—é">‚ò∞</div>
          <div style="min-width:0">
            <div class="title" id="hdrTitle">Mini Messenger</div>
            <div class="sub" id="hdrSub">FastAPI + Render + Postgres + Cloudinary</div>
          </div>
        </div>

        <div class="right">
          <div class="recBadge" id="recBadge">
            <div class="blink"></div>
            <div>REC <span id="recTime">0:00</span></div>
          </div>
          <div class="pill" id="whoami">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
          <div class="btn secondary" id="btnAuth">–í–æ–π—Ç–∏</div>
          <div class="btn danger" id="btnLogout" style="display:none;">–í—ã–π—Ç–∏</div>
        </div>
      </header>

      <div class="main" style="position:relative;">
        <aside id="sidebar">
          <div class="asideTop">
            <div class="searchRow">
              <input id="q" placeholder="–ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤..." />
              <div class="iconbtn" id="btnRefresh" title="–û–±–Ω–æ–≤–∏—Ç—å">‚ü≥</div>
            </div>
            <div class="row" style="display:flex; gap:10px;">
              <input id="newChatTitle" placeholder="–ù–æ–≤—ã–π —á–∞—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ)" />
              <div class="btn" id="btnNewChat">–°–æ–∑–¥–∞—Ç—å</div>
            </div>
            <div class="row" style="display:flex; gap:10px;">
              <input id="dmUser" placeholder="–õ–∏—á–∫–∞: username" />
              <div class="btn secondary" id="btnDM">DM</div>
            </div>
          </div>

          <div class="chats" id="chatList"></div>
        </aside>

        <section>
          <div class="msgs" id="msgs"></div>

          <div class="toBottom" id="btnToBottom">
            <div class="iconbtn" title="–í–Ω–∏–∑">‚Üì</div>
          </div>

          <div class="composer">
            <textarea id="text" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter ‚Äî –ø–µ—Ä–µ–Ω–æ—Å)"></textarea>

            <div class="right">
              <input type="file" id="file" style="display:none;" />
              <div class="iconbtn" id="btnFile" title="–§–∞–π–ª">üìé</div>

              <div class="iconbtn" id="btnRec" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ">üéô</div>

              <div class="btn" id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
            </div>
          </div>

          <div class="status">
            <div id="status">‚Äî</div>
            <div class="pill" id="net">offline</div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Auth modal -->
  <div class="modal" id="authModal">
    <div class="box">
      <div class="tabs">
        <div class="tab active" id="tabLogin">–í—Ö–æ–¥</div>
        <div class="tab" id="tabReg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
      </div>

      <div class="hint" id="authHint">–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</div>

      <input id="authUser" placeholder="username" autocomplete="username"/>
      <input id="authPass" type="password" placeholder="password" autocomplete="current-password"/>

      <div class="row">
        <div class="btn" id="btnAuthGo" style="flex:1;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
        <div class="btn secondary" id="btnAuthClose">–ó–∞–∫—Ä—ã—Ç—å</div>
      </div>

      <div class="hint">
        –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let ws = null;

  let chats = [];
  let activeChatId = localStorage.getItem("activeChatId") || "";
  let activeChatTitle = "";

  function isMobile(){ return window.matchMedia("(max-width: 900px)").matches; }

  /* ===== Drawer ===== */
  const sidebar = $("sidebar");
  const backdrop = $("drawerBackdrop");
  function openSidebar(){ sidebar.classList.add("open"); backdrop.classList.add("open"); }
  function closeSidebar(){ sidebar.classList.remove("open"); backdrop.classList.remove("open"); }
  function toggleSidebar(){ sidebar.classList.contains("open") ? closeSidebar() : openSidebar(); }

  /* ===== Scroll + arrow ===== */
  const toBottomBtn = $("btnToBottom");
  function isNearBottom(el, px=160){
    return (el.scrollHeight - el.scrollTop - el.clientHeight) < px;
  }
  function scrollToBottom(el){ el.scrollTop = el.scrollHeight; }
  function updateToBottom(){
    const box = $("msgs");
    toBottomBtn.classList.toggle("show", !isNearBottom(box));
  }

  /* ===== UI helpers ===== */
  function setStatus(s){ $("status").textContent = s; }
  function setNet(s){ $("net").textContent = s; }
  function setWho(){
    $("whoami").textContent = token ? `@${me}` : "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
    $("btnAuth").style.display = token ? "none" : "inline-flex";
    $("btnLogout").style.display = token ? "inline-flex" : "none";
  }
  function addSystem(text){
    const box = $("msgs");
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<div class="top"><div class="user">System</div><div class="time">‚Äî</div></div>
      <div class="text">${escapeHtml(text)}</div>`;
    box.appendChild(div);
    if (isNearBottom(box)) scrollToBottom(box);
    updateToBottom();
  }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }
  function fmtTime(ts){
    try{
      const d = new Date(ts * 1000);
      return d.toLocaleString(undefined, {hour:"2-digit", minute:"2-digit"});
    }catch(_){
      return "‚Äî";
    }
  }

  /* ===== API ===== */
  const API_BASE = ""; // same domain
  async function api(path, method="GET", body=null, isForm=false){
    const headers = {};
    if (token) headers["Authorization"] = `Bearer ${token}`;
    if (!isForm) headers["Content-Type"] = "application/json";

    const res = await fetch(API_BASE + path, {
      method,
      headers,
      body: body ? (isForm ? body : JSON.stringify(body)) : undefined
    });

    const txt = await res.text();
    let data = {};
    try{ data = txt ? JSON.parse(txt) : {}; }catch(_){}
    if (!res.ok){
      const msg = data?.detail || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  /* ===== Voice waveform player (Telegram-like) ===== */
  const VOICE = {
    peaksCache: new Map(),   // url -> Float32Array peaks
    audioCache: new Map(),   // url -> HTMLAudioElement
    players: new Set(),      // active players
  };

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function fmtClock(sec){
    sec = Math.max(0, sec || 0);
    const m = String(Math.floor(sec/60));
    const s = String(Math.floor(sec%60)).padStart(2,"0");
    return `${m}:${s}`;
  }

  async function getPeaks(url, samples = 120){
    if (VOICE.peaksCache.has(url)) return VOICE.peaksCache.get(url);

    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error(`waveform fetch failed: ${res.status}`);
    const buf = await res.arrayBuffer();

    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) throw new Error("AudioContext not supported");

    const ctx = new Ctx();
    const audioBuf = await ctx.decodeAudioData(buf.slice(0));
    try{ await ctx.close(); }catch(_){}

    const ch = audioBuf.getChannelData(0);
    const block = Math.floor(ch.length / samples) || 1;

    const peaks = new Float32Array(samples);
    for (let i=0;i<samples;i++){
      let start = i * block;
      let end = Math.min(ch.length, start + block);
      let max = 0;
      for (let j=start;j<end;j++){
        const v = Math.abs(ch[j]);
        if (v > max) max = v;
      }
      peaks[i] = max;
    }

    let pmax = 0;
    for (let i=0;i<peaks.length;i++) pmax = Math.max(pmax, peaks[i]);
    const k = pmax > 0 ? (1 / pmax) : 1;
    for (let i=0;i<peaks.length;i++) peaks[i] *= k;

    VOICE.peaksCache.set(url, peaks);
    return peaks;
  }

  function getOrCreateAudio(url){
    if (VOICE.audioCache.has(url)) return VOICE.audioCache.get(url);
    const a = new Audio(url);
    a.preload = "metadata";
    a.crossOrigin = "anonymous";
    VOICE.audioCache.set(url, a);
    return a;
  }

  function stopAllExcept(except){
    for (const p of VOICE.players){
      if (p !== except) p.stop();
    }
  }

  function drawWave(canvas, peaks, progress01){
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || 300;
    const cssH = canvas.clientHeight || 34;
    const W = Math.floor(cssW * dpr);
    const H = Math.floor(cssH * dpr);

    if (canvas.width !== W) canvas.width = W;
    if (canvas.height !== H) canvas.height = H;

    const ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,W,H);

    const n = peaks.length;
    const gap = Math.floor(2 * dpr);
    const barW = Math.max(1, Math.floor((W - gap*(n-1)) / n));
    const mid = Math.floor(H/2);
    const maxBar = Math.floor(H * 0.78);

    const progX = Math.floor(W * clamp(progress01, 0, 1));

    for (let i=0;i<n;i++){
      const x = i * (barW + gap);
      const amp = peaks[i];
      const h = Math.max(2*dpr, Math.floor(amp * maxBar));
      const y = mid - Math.floor(h/2);

      const filled = (x + barW) <= progX;
      ctx.fillStyle = filled ? "rgba(230,238,252,.95)" : "rgba(230,238,252,.35)";
      ctx.fillRect(x, y, barW, h);
    }
  }

  function createVoicePlayer(url){
    const root = document.createElement("div");
    root.className = "voice";

    const btn = document.createElement("div");
    btn.className = "play";
    btn.textContent = "‚ñ∂";
    btn.title = "Play/Pause";

    const waveWrap = document.createElement("div");
    waveWrap.className = "wave";

    const canvas = document.createElement("canvas");
    canvas.height = 34;

    const timeRow = document.createElement("div");
    timeRow.className = "time";

    const left = document.createElement("span");
    left.textContent = "0:00";

    const right = document.createElement("span");
    right.textContent = "0:00";

    timeRow.appendChild(left);
    timeRow.appendChild(right);

    waveWrap.appendChild(canvas);
    waveWrap.appendChild(timeRow);

    root.appendChild(btn);
    root.appendChild(waveWrap);

    const audio = getOrCreateAudio(url);

    const player = {
      root, btn, canvas, audio,
      peaks: null,
      raf: 0,
      destroyed: false,

      async init(){
        try{
          this.peaks = await getPeaks(url, 120);
          if (this.destroyed) return;
          drawWave(this.canvas, this.peaks, 0);
        }catch(e){
          // fallback: if waveform cannot be decoded, keep playback working
          this.peaks = new Float32Array(120);
          for (let i=0;i<this.peaks.length;i++) this.peaks[i] = 0.15;
          drawWave(this.canvas, this.peaks, 0);
        }
      },

      setBtn(){ this.btn.textContent = this.audio.paused ? "‚ñ∂" : "‚è∏"; },

      tick(){
        if (this.destroyed) return;
        const dur = this.audio.duration || 0;
        const cur = this.audio.currentTime || 0;
        left.textContent = fmtClock(cur);
        right.textContent = dur ? fmtClock(dur) : "0:00";
        const p = dur ? (cur / dur) : 0;
        if (this.peaks) drawWave(this.canvas, this.peaks, p);
        this.raf = requestAnimationFrame(()=> this.tick());
      },

      playPause(){
        stopAllExcept(this);
        if (this.audio.paused){
          this.audio.play().catch(()=>{});
        } else {
          this.audio.pause();
        }
      },

      stop(){
        try{ this.audio.pause(); }catch(_){}
        try{ this.audio.currentTime = 0; }catch(_){}
        this.setBtn();
        if (this.peaks) drawWave(this.canvas, this.peaks, 0);
        if (this.raf) cancelAnimationFrame(this.raf);
        this.raf = 0;
      },

      seekByClientX(clientX){
        const r = this.canvas.getBoundingClientRect();
        const x = clamp(clientX - r.left, 0, r.width);
        const p = r.width ? (x / r.width) : 0;
        const dur = this.audio.duration || 0;
        if (dur) this.audio.currentTime = p * dur;
      },

      destroy(){
        this.destroyed = true;
        this.stop();
        VOICE.players.delete(this);
      }
    };

    btn.onclick = () => player.playPause();

    canvas.addEventListener("click", (e)=>{
      player.seekByClientX(e.clientX);
      player.setBtn();
      const dur = audio.duration || 0;
      const cur = audio.currentTime || 0;
      const p = dur ? (cur/dur) : 0;
      if (player.peaks) drawWave(canvas, player.peaks, p);
    });

    audio.addEventListener("loadedmetadata", ()=>{
      right.textContent = fmtClock(audio.duration || 0);
    });

    audio.addEventListener("play", ()=>{
      player.setBtn();
      if (!player.raf) player.tick();
    });

    audio.addEventListener("pause", ()=>{
      player.setBtn();
      if (player.raf) cancelAnimationFrame(player.raf);
      player.raf = 0;
      const dur = audio.duration || 0;
      const cur = audio.currentTime || 0;
      const p = dur ? (cur/dur) : 0;
      if (player.peaks) drawWave(canvas, player.peaks, p);
    });

    audio.addEventListener("ended", ()=> player.stop());

    VOICE.players.add(player);
    player.init();
    return player;
  }

  /* ===== Auth modal ===== */
  const authModal = $("authModal");
  let authMode = "login"; // login|reg

  function openAuth(mode="login"){
    authMode = mode;
    authModal.classList.add("open");
    $("authUser").focus();
    renderAuthTabs();
  }
  function closeAuth(){
    authModal.classList.remove("open");
  }
  function renderAuthTabs(){
    const isLogin = authMode === "login";
    $("tabLogin").classList.toggle("active", isLogin);
    $("tabReg").classList.toggle("active", !isLogin);
    $("authHint").textContent = isLogin ? "–í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç" : "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç";
    $("authPass").autocomplete = isLogin ? "current-password" : "new-password";
  }

  async function doAuth(){
    const u = $("authUser").value.trim();
    const p = $("authPass").value.trim();
    if (!u || !p){
      addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ username –∏ password.");
      return;
    }
    try{
      if (authMode === "login"){
        const data = await api("/api/auth/login", "POST", {username:u, password:p});
        token = data.token;
        me = data.username;
      } else {
        const data = await api("/api/auth/register", "POST", {username:u, password:p});
        token = data.token;
        me = data.username;
      }
      localStorage.setItem("token", token);
      localStorage.setItem("username", me);
      setWho();
      closeAuth();
      await refreshChats(true);
      connectWS();
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  }

  /* ===== Chats ===== */
  function renderChats(){
    const list = $("chatList");
    list.innerHTML = "";

    const q = $("q").value.trim().toLowerCase();
    const filtered = chats.filter(c => !q || (c.title || "").toLowerCase().includes(q) || (c.id || "").toLowerCase().includes(q));

    if (!filtered.length){
      const empty = document.createElement("div");
      empty.style.opacity = ".85";
      empty.style.color = "var(--muted)";
      empty.style.padding = "10px";
      empty.textContent = "–ù–µ—Ç —á–∞—Ç–æ–≤";
      list.appendChild(empty);
      return;
    }

    for (const c of filtered){
      const div = document.createElement("div");
      div.className = "chat" + (c.id === activeChatId ? " active" : "");
      div.onclick = () => {
        selectChat(c.id);
        if (isMobile()) closeSidebar();
      };

      div.innerHTML = `
        <div class="dot"></div>
        <div class="meta">
          <div class="t">${escapeHtml(c.title || c.id)}</div>
          <div class="s">${escapeHtml(c.type || "chat")}</div>
        </div>
      `;
      list.appendChild(div);
    }
  }

  async function refreshChats(scrollToLast=true){
    if (!token){
      chats = [];
      renderChats();
      $("msgs").innerHTML = "";
      setStatus("–ù—É–∂–µ–Ω –≤—Ö–æ–¥");
      return;
    }
    try{
      const data = await api("/api/chats", "GET");
      chats = data.chats || [];
      renderChats();

      if (!activeChatId && chats.length){
        activeChatId = chats[0].id;
        localStorage.setItem("activeChatId", activeChatId);
      }

      if (activeChatId){
        await loadMessages(activeChatId, scrollToLast);
      } else {
        $("msgs").innerHTML = "";
        setStatus("–í—ã–±–µ—Ä–∏ —á–∞—Ç");
      }
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  }

  async function createChat(title){
    const t = (title || "").trim();
    if (!t) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.");
    const data = await api("/api/chats", "POST", {title: t});
    addSystem(`‚úÖ –°–æ–∑–¥–∞–Ω —á–∞—Ç: ${data.chat.title}`);
    await refreshChats(false);
    selectChat(data.chat.id);
  }

  async function createDM(user){
    const u = (user || "").trim();
    if (!u) return addSystem("‚ö†Ô∏è –í–≤–µ–¥–∏ username.");
    const data = await api("/api/chats/dm", "POST", {username: u});
    addSystem(`‚úÖ ${data.chat.title}`);
    await refreshChats(false);
    selectChat(data.chat.id);
  }

  /* ===== Media upload (image/video/audio/voice) ===== */
  async function uploadMedia(file){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");

    const caption = $("text").value.trim();

    const maxBytes = 25 * 1024 * 1024;
    if (file.size > maxBytes){
      addSystem("‚ö†Ô∏è –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–ª–∏–º–∏—Ç 25MB).");
      $("file").value = "";
      return;
    }

    const fd = new FormData();
    fd.append("chat_id", activeChatId);
    fd.append("caption", caption);
    fd.append("file", file);

    try{
      setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...");
      $("btnSend").textContent = "‚Ä¶";
      $("btnSend").style.pointerEvents = "none";

      await api("/api/messages/upload", "POST", fd, true);
      $("text").value = "";
      $("file").value = "";
      setStatus("–§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω");
    }catch(e){
      addSystem("‚ùå " + e.message);
    }finally{
      $("btnSend").textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      $("btnSend").style.pointerEvents = "auto";
    }
  }

  /* ===== Messages ===== */
  function addMsg(msg){
    const box = $("msgs");
    const div = document.createElement("div");
    const mine = msg.username === me;
    div.className = "msg" + (mine ? " me" : "");

    const created = msg.created_at ? fmtTime(msg.created_at) : "‚Äî";
    const media_url = msg.media_url || "";
    const media_kind = msg.media_kind || "";
    const text = msg.text || "";

    div.innerHTML = `
      <div class="top">
        <div class="user">${escapeHtml(msg.username || "‚Äî")}</div>
        <div class="time">${escapeHtml(created)}</div>
      </div>
      <div class="text">${escapeHtml(text)}</div>
    `;

    if (media_url && media_kind === "image"){
      const wrap = document.createElement("div");
      wrap.className = "media";
      const img = document.createElement("img");
      img.src = media_url;
      img.loading = "lazy";
      img.alt = "image";
      wrap.appendChild(img);
      div.appendChild(wrap);
    }

    if (media_url && media_kind === "video"){
      const wrap = document.createElement("div");
      wrap.className = "media";
      const v = document.createElement("video");
      v.src = media_url;
      v.controls = true;
      v.playsInline = true;
      wrap.appendChild(v);
      div.appendChild(wrap);
    }

    if (media_url && media_kind === "audio"){
      const wrap = document.createElement("div");
      wrap.className = "media";
      wrap.style.padding = "10px";

      const player = createVoicePlayer(media_url);
      wrap.appendChild(player.root);

      div.appendChild(wrap);
    }

    box.appendChild(div);
    if (isNearBottom(box)) scrollToBottom(box);
    updateToBottom();
  }

  async function loadMessages(chatId, scrollToLast=true){
    if (!token) return;
    try{
      setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...");
      const data = await api(`/api/messages?chat_id=${encodeURIComponent(chatId)}`, "GET");
      const msgs = data.messages || [];
      const box = $("msgs");
      box.innerHTML = "";
      for (const m of msgs) addMsg(m);
      if (scrollToLast) scrollToBottom(box);
      updateToBottom();
      setStatus(`–ß–∞—Ç: ${activeChatTitle || chatId}`);
      $("hdrTitle").textContent = activeChatTitle ? `–ß–∞—Ç: ${activeChatTitle}` : `–ß–∞—Ç: ${chatId}`;
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  }

  async function sendText(){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");

    const text = $("text").value.trim();
    if (!text) return;

    try{
      await api("/api/messages", "POST", {chat_id: activeChatId, text});
      $("text").value = "";
      setStatus("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  }

  function selectChat(chatId){
    if (rec.active) stopRecording();
    stopAllExcept(null);

    activeChatId = chatId;
    localStorage.setItem("activeChatId", activeChatId);

    const found = chats.find(c => c.id === chatId);
    if (found){
      activeChatTitle = found.title || found.id;
      if (found.type === "dm" && found.title && found.title.startsWith("dm:")){
        const parts = found.title.slice(3).split("|");
        if (parts.length === 2){
          const other = parts[0] === me ? parts[1] : parts[0];
          activeChatTitle = `DM: ${other}`;
        }
      }
      $("hdrTitle").textContent = activeChatTitle ? `–ß–∞—Ç: ${activeChatTitle}` : `–ß–∞—Ç: ${chatId}`;
    } else {
      activeChatTitle = "";
      $("hdrTitle").textContent = `–ß–∞—Ç: ${chatId}`;
    }

    renderChats();
    loadMessages(chatId, true);
  }

  /* ===== WebSocket ===== */
  function connectWS(){
    if (!token) return;
    if (ws) try{ ws.close(); }catch(_){}
    ws = null;

    const proto = location.protocol === "https:" ? "wss:" : "ws:";
    const url = `${proto}//${location.host}/ws?token=${encodeURIComponent(token)}`;
    setNet("connecting‚Ä¶");

    ws = new WebSocket(url);

    ws.onopen = () => { setNet("online"); };
    ws.onclose = () => { setNet("offline"); };
    ws.onerror = () => { setNet("offline"); };

    ws.onmessage = (ev) => {
      try{
        const msg = JSON.parse(ev.data);
        if (msg.type === "message"){
          if (msg.chat_id === activeChatId){
            addMsg(msg.message);
          }
        }
        if (msg.type === "chat_created"){
          refreshChats(false);
        }
      }catch(_){}
    };
  }

  /* ===== Recording voice ===== */
  const rec = {
    active: false,
    mediaRecorder: null,
    chunks: [],
    startedAt: 0,
    timer: 0,
    stream: null,
  };

  function showRec(on){
    $("recBadge").classList.toggle("show", !!on);
  }

  function updateRecTime(){
    const sec = Math.floor((Date.now() - rec.startedAt) / 1000);
    $("recTime").textContent = fmtClock(sec);
  }

  async function startRecording(){
    if (!token) return openAuth("login");
    if (!activeChatId) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —á–∞—Ç.");

    if (!navigator.mediaDevices?.getUserMedia){
      addSystem("‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
      return;
    }

    try{
      rec.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      rec.chunks = [];
      rec.startedAt = Date.now();

      const mr = new MediaRecorder(rec.stream, { mimeType: "audio/webm" });
      rec.mediaRecorder = mr;

      mr.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) rec.chunks.push(e.data);
      };

      mr.onstop = async () => {
        try{
          const blob = new Blob(rec.chunks, { type: "audio/webm" });
          const file = new File([blob], `voice_${Date.now()}.webm`, { type: "audio/webm" });
          await uploadMedia(file);
        }catch(e){
          addSystem("‚ùå " + e.message);
        }finally{
          if (rec.stream){
            rec.stream.getTracks().forEach(t => t.stop());
          }
          rec.stream = null;
          rec.mediaRecorder = null;
          rec.chunks = [];
        }
      };

      mr.start(250);
      rec.active = true;
      showRec(true);
      updateRecTime();
      rec.timer = setInterval(updateRecTime, 250);
      setStatus("–ó–∞–ø–∏—Å—å...");
    }catch(e){
      addSystem("‚ùå " + e.message);
    }
  }

  function stopRecording(){
    if (!rec.active) return;
    rec.active = false;
    showRec(false);
    clearInterval(rec.timer);
    rec.timer = 0;

    try{
      rec.mediaRecorder?.stop();
    }catch(_){}
    setStatus("–û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ...");
  }

  /* ===== Logout ===== */
  function logout(){
    if (rec.active) stopRecording();

    token = ""; me = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    localStorage.removeItem("activeChatId");

    if (ws) ws.close();
    ws = null;
    stopAllExcept(null);

    chats = [];
    activeChatId = "";
    activeChatTitle = "";
    $("msgs").innerHTML = "";
    renderChats();
    setWho();
    setStatus("–í—ã –≤—ã—à–ª–∏");
    setNet("offline");
  }

  /* ===== Wiring ===== */
  $("btnMenu").onclick = toggleSidebar;
  $("drawerBackdrop").onclick = closeSidebar;

  $("btnToBottom").onclick = () => scrollToBottom($("msgs"));
  $("msgs").addEventListener("scroll", updateToBottom);

  $("btnAuth").onclick = () => openAuth("login");
  $("btnLogout").onclick = logout;

  $("tabLogin").onclick = () => { authMode = "login"; renderAuthTabs(); };
  $("tabReg").onclick = () => { authMode = "reg"; renderAuthTabs(); };
  $("btnAuthClose").onclick = closeAuth;
  $("btnAuthGo").onclick = doAuth;

  authModal.addEventListener("click", (e)=>{
    if (e.target === authModal) closeAuth();
  });

  $("btnRefresh").onclick = () => refreshChats(false);
  $("q").oninput = renderChats;

  $("btnNewChat").onclick = () => createChat($("newChatTitle").value);
  $("btnDM").onclick = () => createDM($("dmUser").value);

  $("btnSend").onclick = sendText;

  $("text").addEventListener("keydown", (e)=>{
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendText();
    }
  });

  $("btnFile").onclick = () => $("file").click();
  $("file").onchange = () => {
    const f = $("file").files?.[0];
    if (f) uploadMedia(f);
  };

  $("btnRec").onclick = () => {
    if (!rec.active) startRecording();
    else stopRecording();
  };

  /* ===== Boot ===== */
  setWho();
  updateToBottom();

  (async () => {
    if (token){
      try{
        await refreshChats(true);
        connectWS();
        setStatus("–ì–æ—Ç–æ–≤–æ");
      }catch(_){}
    } else {
      setStatus("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å");
    }
  })();
</script>
</body>
</html>
