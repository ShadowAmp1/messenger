<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mini Messenger</title>
  <style>
    body { font-family: system-ui, Arial; margin: 0; background: #0b1220; color: #e6eefc; }
    .wrap { display: grid; place-items: center; min-height: 100vh; padding: 16px; }
    .card { width: min(1060px, 100%); background: #121a2b; border: 1px solid #24304a; border-radius: 14px; overflow: hidden; }
    .top { display:flex; gap: 10px; padding: 14px; border-bottom: 1px solid #24304a; align-items: center; }
    .top input { flex:1; padding: 10px; border-radius: 10px; border: 1px solid #24304a; background:#0b1220; color:#e6eefc; }
    .top button { padding: 10px 14px; border-radius: 10px; border: 1px solid #24304a; background:#1b2742; color:#e6eefc; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 320px 1fr; height: 74vh; }
    .sidebar { border-right: 1px solid #24304a; padding: 14px; display:flex; flex-direction: column; gap: 12px; }
    .chat { display:flex; flex-direction: column; }
    .msgs { flex:1; overflow:auto; padding: 14px; display:flex; flex-direction: column; gap: 10px; }
    .msg { max-width: 85%; padding: 10px 12px; border-radius: 12px; border: 1px solid #24304a; background:#0b1220; }
    .me { align-self: flex-end; background:#12284a; }
    .meta { font-size: 12px; opacity: .8; margin-bottom: 4px; }
    .composer { display:flex; gap: 10px; padding: 14px; border-top: 1px solid #24304a; }
    .composer input { flex:1; padding: 12px; border-radius: 12px; border: 1px solid #24304a; background:#0b1220; color:#e6eefc; }
    .composer button { padding: 12px 16px; border-radius: 12px; border: 1px solid #24304a; background:#1b2742; color:#e6eefc; cursor:pointer; }
    .hint { font-size: 13px; opacity: .9; }
    .row { display:flex; gap: 8px; flex-wrap: wrap; }
    .small { font-size: 12px; opacity: .8; word-break: break-word; }
    .sep { height: 1px; background:#24304a; opacity:.8; margin: 6px 0; }

    .chatlist { display:flex; flex-direction: column; gap: 6px; overflow:auto; padding-right: 4px; }
    .chatitem {
      display:flex; align-items: center; justify-content: space-between;
      gap: 8px;
      padding: 10px 10px;
      border: 1px solid #24304a;
      border-radius: 12px;
      background:#0b1220;
      cursor:pointer;
    }
    .chatitem:hover { filter: brightness(1.08); }
    .chatitem.active { background:#12284a; }
    .badge { font-size: 11px; opacity:.9; padding: 2px 8px; border: 1px solid #24304a; border-radius: 999px; }
    .title { font-weight: 600; }
    .muted { opacity: .85; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <!-- Auth bar -->
      <div class="top">
        <input id="username" placeholder="username" />
        <input id="password" placeholder="password" type="password" />
        <button id="btnRegister" type="button">Register</button>
        <button id="btnLogin" type="button">Login</button>
        <button id="btnLogout" type="button">Logout</button>
      </div>

      <div class="grid">
        <!-- Sidebar -->
        <div class="sidebar">
          <div>
            <div class="row" style="justify-content: space-between; align-items: baseline;">
              <div><b>Chats</b></div>
              <div class="small" id="whoami"></div>
            </div>
            <div class="small" id="status"></div>
          </div>

          <div class="sep"></div>

          <div>
            <div class="hint"><b>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç</b></div>
            <div class="row" style="margin-top:8px;">
              <input id="newChatTitle" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: work" style="flex:1; padding:10px; border-radius:10px; border:1px solid #24304a; background:#0b1220; color:#e6eefc;">
              <button id="btnCreateChat" type="button">Create</button>
            </div>
          </div>

          <div>
            <div class="hint"><b>–õ–∏—á–∫–∞ (DM)</b></div>
            <div class="row" style="margin-top:8px;">
              <input id="dmUser" placeholder="username" style="flex:1; padding:10px; border-radius:10px; border:1px solid #24304a; background:#0b1220; color:#e6eefc;">
              <button id="btnCreateDM" type="button">DM</button>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button id="btnRefreshChats" type="button">Refresh</button>
            <button id="btnLoadHistory" type="button">Load history</button>
          </div>

          <div class="sep"></div>

          <div class="chatlist" id="chatlist"></div>

          <div class="small" style="margin-top:auto;">
            –ü–æ–¥—Å–∫–∞–∑–∫–∞: DM —Å–æ–∑–¥–∞—ë—Ç—Å—è, –µ—Å–ª–∏ –æ–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã.
          </div>
        </div>

        <!-- Chat -->
        <div class="chat">
          <div class="msgs" id="msgs"></div>
          <div class="composer">
            <input id="text" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button id="btnSend" type="button">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let token = localStorage.getItem("token") || "";
  let me = localStorage.getItem("username") || "";
  let ws = null;

  let chats = [];
  let activeChatId = localStorage.getItem("activeChatId") || "general";
  let activeChatTitle = "general";

  function setStatus(s){ $("status").textContent = s; }
  function setWhoami(){
    $("whoami").textContent = me ? `üë§ ${me}` : "not logged in";
  }

  function addSystem(text) {
    const div = document.createElement("div");
    div.className = "msg";
    div.style.opacity = ".85";
    div.textContent = text;
    $("msgs").appendChild(div);
    $("msgs").scrollTop = $("msgs").scrollHeight;
  }

  function addMsg({sender, text, created_at}) {
    const div = document.createElement("div");
    div.className = "msg" + (sender === me ? " me" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    const t = new Date(created_at * 1000).toLocaleTimeString();
    meta.textContent = `${sender} ‚Ä¢ ${t}`;
    const body = document.createElement("div");
    body.textContent = text;
    div.appendChild(meta);
    div.appendChild(body);
    $("msgs").appendChild(div);
    $("msgs").scrollTop = $("msgs").scrollHeight;
  }

  async function api(path, method="GET", body=null) {
    const opts = { method, headers: {} };
    if (body) {
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }

    const res = await fetch(path, opts);
    const raw = await res.text();

    let data = {};
    try { data = JSON.parse(raw); }
    catch { data = { detail: raw }; }

    if (!res.ok) {
      throw new Error(`${res.status} ${res.statusText}: ${data.detail || raw}`);
    }
    return data;
  }

  // ---------------- Auth ----------------
  async function registerUser() {
    const username = $("username").value.trim();
    const password = $("password").value;
    await api("/api/register", "POST", {username, password});
    addSystem("‚úÖ Registered. –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ Login.");
  }

  async function loginUser() {
    const username = $("username").value.trim();
    const password = $("password").value;

    const data = await api("/api/login", "POST", {username, password});
    token = data.token;
    me = data.username;
    localStorage.setItem("token", token);
    localStorage.setItem("username", me);

    setWhoami();
    addSystem(`‚úÖ Logged in as ${me}`);

    await refreshChats();
    // ensure active chat exists
    if (!chats.find(c => c.id === activeChatId)) activeChatId = "general";
    selectChat(activeChatId);
  }

  function logout() {
    token = ""; me = "";
    localStorage.removeItem("token");
    localStorage.removeItem("username");
    localStorage.removeItem("activeChatId");

    if (ws) ws.close();
    ws = null;

    chats = [];
    activeChatId = "general";
    activeChatTitle = "general";

    $("chatlist").innerHTML = "";
    $("msgs").innerHTML = "";
    setStatus("");
    setWhoami();
    addSystem("üëã Logged out");
  }

  // ---------------- Chats ----------------
  function renderChatList() {
    const list = $("chatlist");
    list.innerHTML = "";

    // always show general on top
    const ordered = [...chats].sort((a,b) => (a.id === "general" ? -1 : 0) + (b.id === "general" ? 1 : 0));

    for (const c of ordered) {
      const item = document.createElement("div");
      item.className = "chatitem" + (c.id === activeChatId ? " active" : "");
      const left = document.createElement("div");
      left.style.display = "flex";
      left.style.flexDirection = "column";
      left.style.gap = "2px";

      let title = c.title;
      let typeLabel = c.type;

      // backend stores dm title as "dm:a|b", but /api/chats returns that raw title
      if (c.type === "dm" && c.title.startsWith("dm:")) {
        const parts = c.title.slice(3).split("|");
        const other = parts[0] === me ? parts[1] : parts[0];
        title = `DM: ${other}`;
      }

      const t1 = document.createElement("div");
      t1.className = "title";
      t1.textContent = title;

      const t2 = document.createElement("div");
      t2.className = "small muted";
      t2.textContent = c.id;

      left.appendChild(t1);
      left.appendChild(t2);

      const badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = typeLabel;

      item.appendChild(left);
      item.appendChild(badge);

      item.onclick = () => selectChat(c.id);
      list.appendChild(item);
    }
  }

  async function refreshChats() {
    if (!token) {
      addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏–Ω.");
      return;
    }
    const data = await api(`/api/chats?token=${encodeURIComponent(token)}`);
    chats = data.chats || [];
    // if for some reason "general" not returned, add it
    if (!chats.find(c => c.id === "general")) {
      chats.push({id:"general", type:"group", title:"general", created_at: 0});
    }
    renderChatList();
  }

  async function createChat() {
    if (!token) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏–Ω.");
    const title = $("newChatTitle").value.trim();
    const data = await api(`/api/chats?token=${encodeURIComponent(token)}`, "POST", {title});
    $("newChatTitle").value = "";
    addSystem(`‚úÖ Created chat: ${data.chat.title}`);
    await refreshChats();
    selectChat(data.chat.id);
  }

  async function createDM() {
    if (!token) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏–Ω.");
    const username = $("dmUser").value.trim();
    const data = await api(`/api/chats/dm?token=${encodeURIComponent(token)}`, "POST", {username});
    $("dmUser").value = "";
    addSystem(`‚úÖ DM ready: ${data.chat.title}`);
    await refreshChats();
    selectChat(data.chat.id);
  }

  function selectChat(chatId) {
    activeChatId = chatId;
    localStorage.setItem("activeChatId", activeChatId);

    const found = chats.find(c => c.id === chatId);
    if (found) {
      activeChatTitle = found.title;
      if (found.type === "dm" && found.title.startsWith("dm:")) {
        const parts = found.title.slice(3).split("|");
        const other = parts[0] === me ? parts[1] : parts[0];
        activeChatTitle = `DM: ${other}`;
      }
    } else {
      activeChatTitle = chatId;
    }

    $("msgs").innerHTML = "";
    addSystem(`üìå Chat: ${activeChatTitle}`);

    renderChatList();
    connectWS();
    loadHistory().catch(err => addSystem("‚ùå " + err.message));
  }

  // ---------------- Messages ----------------
  async function loadHistory() {
    if (!token) return addSystem("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –ª–æ–≥–∏–Ω.");
    $("msgs").innerHTML = "";
    addSystem(`üì• Loading history: ${activeChatTitle}...`);
    const data = await api(`/api/messages?token=${encodeURIComponent(token)}&chat_id=${encodeURIComponent(activeChatId)}`);
    $("msgs").innerHTML = "";
    for (const m of data.messages) addMsg(m);
  }

  function connectWS() {
    if (!token) return;

    if (ws) ws.close();
    const proto = location.protocol === "https:" ? "wss" : "ws";
    ws = new WebSocket(`${proto}://${location.host}/ws?token=${encodeURIComponent(token)}&chat_id=${encodeURIComponent(activeChatId)}`);

    ws.onopen = () => setStatus(`üü¢ WS Connected ‚Ä¢ ${activeChatTitle}`);
    ws.onclose = () => setStatus("üî¥ WS Disconnected");
    ws.onerror = () => setStatus("‚ö†Ô∏è WS error");

    ws.onmessage = (ev) => {
      const data = JSON.parse(ev.data);
      if (data.type === "message") {
        // only add if message for current chat
        if (data.chat_id === activeChatId) addMsg(data);
      }
    };
  }

  function send() {
    const text = $("text").value.trim();
    if (!text) return;
    if (!ws || ws.readyState !== 1) return addSystem("‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è WS");
    ws.send(JSON.stringify({type:"message", text}));
    $("text").value = "";
  }

  // ---------------- UI wiring ----------------
  $("btnRegister").onclick = () => registerUser().catch(e => addSystem("‚ùå " + e.message));
  $("btnLogin").onclick = () => loginUser().catch(e => addSystem("‚ùå " + e.message));
  $("btnLogout").onclick = () => logout();

  $("btnRefreshChats").onclick = () => refreshChats().catch(e => addSystem("‚ùå " + e.message));
  $("btnCreateChat").onclick = () => createChat().catch(e => addSystem("‚ùå " + e.message));
  $("btnCreateDM").onclick = () => createDM().catch(e => addSystem("‚ùå " + e.message));
  $("btnLoadHistory").onclick = () => loadHistory().catch(e => addSystem("‚ùå " + e.message));

  $("btnSend").onclick = () => send();
  $("text").addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

  // ---------------- Auto restore session ----------------
  setWhoami();
  if (token) {
    addSystem(`üîÅ Restoring session for ${me || "user"}...`);
    refreshChats()
      .then(() => {
        if (!chats.find(c => c.id === activeChatId)) activeChatId = "general";
        selectChat(activeChatId);
      })
      .catch(() => {});
  } else {
    addSystem("üëã –ü—Ä–∏–≤–µ—Ç! –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –∏–ª–∏ –∑–∞–ª–æ–≥–∏–Ω—å—Å—è.");
  }
</script>
</body>
</html>
